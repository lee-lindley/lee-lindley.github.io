<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="shortcut icon" href="/static/img/favicon.ico" /><title>Using Perl DBD::Oracle to write LOB content - Lee Lindley Scratchpad</title><meta name="author" content="Lee Lindley" /><meta name="description" content="Using Perl DBD::Oracle to write LOB content" /><meta name="keywords" content="Using Perl DBD::Oracle to write LOB content, Lee Lindley Scratchpad, oracle, perl" /><link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml"><meta content="" property="fb:app_id"><meta content="Lee Lindley Scratchpad" property="og:site_name"><meta content="Using Perl DBD::Oracle to write LOB content" property="og:title"><meta content="article" property="og:type"><meta content="Posts on Technical Subjects, mostly Oracle and Linux" property="og:description"><meta content="https://lee-lindley.github.io/oracle/perl/2022/04/30/perl_dbd_oracle_clob.html" property="og:url"><meta content="2022-04-30T10:30:00-04:00" property="article:published_time"><meta content="https://lee-lindley.github.io/about/" property="article:author"><meta content="oracle" property="article:section"><meta content="oracle" property="article:tag"><meta content="perl" property="article:tag"><meta content="DBI" property="article:tag"><meta content="DBD" property="article:tag"><meta content="CLOB" property="article:tag"><meta content="BLOB" property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@"><meta name="twitter:creator" content="@"><meta name="twitter:title" content="Using Perl DBD::Oracle to write LOB content"><meta name="twitter:url" content="https://lee-lindley.github.io/oracle/perl/2022/04/30/perl_dbd_oracle_clob.html"><meta name="twitter:description" content="Posts on Technical Subjects, mostly Oracle and Linux"><link href="/static/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous"><link rel="stylesheet" href="/static/css/syntax.css"><link href="/static/css/bootstrap.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:400,300italic,300,400italic,700&amp;subset=latin,latin-ext" rel="stylesheet" type="text/css"><link rel="stylesheet" href="/static/css/super-search.css"><link rel="stylesheet" href="/static/css/thickbox.css"><link rel="stylesheet" href="/static/css/projects.css"><link rel="stylesheet" href="/static/css/main.css"><body><div class="container"><div class="col-sm-3"><div class="fixed-condition"><h1 class="author-name"><a href="/">Lee Lindley</a></h1><div class="profile-about"> I'm Just Another Perl Hacker who wound up in a big Oracle Database playground</div><div class="social"><ul><li><a href="https://linkedin.com/in/lee-lindley" target="_blank"><i class="fa fa-linkedin"></i></a><li><a href="https://github.com/lee-lindley" target="_blank"><i class="fa fa-github"></i></a></ul></div><div class="search" id="js-search"> <input type="text" placeholder="(sitemap)~$ type to search" class="search__input form-control" id="js-search__input"><ul class="search__results" id="js-search__results"></ul></div><hr /><ul class="sidebar-nav"> <strong>Navigation</strong><li><a href="/">Home</a><li><a class="about" href="/about/">About Me</a><li><a class="about" href="/projects/">My Projects</a><li><a class="about" href="/feed.xml">XML Feed</a></ul></div></div><div class="col-sm-8 col-offset-1 main-layout"><header class="post-header"><h1 class="post-title">Using Perl DBD::Oracle to write LOB content</h1></header><span class="time">30 Apr 2022</span> <span class="categories"> &raquo; <a href="/category/oracle">oracle</a>, <a href="/category/perl">perl</a> </span><div class="content"><div class="post"><h1 id="introduction">Introduction</h1><p>We have a need to get large volumes of data and/or <em>BLOB/CLOB</em> content out of the database and onto disk on a remote client machine.<p>We can do it from <em>sqlplus</em>. Even <em>BLOB</em> data can be output as I demonstrated in <a href="https://lee-lindley.github.io/oracle/sql/plsql/2021/12/18/sqlplus-blob.html">Extracting BLOB from Oracle with Sqlplus</a>. I happen to think it is a clunky way to do things when there are nice scripting languages around, but the one constant you can count on having available on a client is <em>sqlplus</em> and some form of <em>shell</em> script capability, even if it is <em>Powershell</em> on Windows.<p>If you have access to <em>Pro-C</em> compilation, there is a nice tool Tom Kyte published long ago named <em>flat</em> you can find <a href="https://asktom.oracle.com/pls/apex/f?p=100:11:0::::P11_QUESTION_ID:459020243348">here</a>. It is a super-fast and efficient solution. It doesn’t do <em>CLOB</em> or <em>BLOB</em>, but with a little elbow grease I’m sure one could manage it. <em>Pro-C</em> has everything you need to handle a <em>LOB Locator</em> and retrieve the content.<p>I know it is doable in Java, and I suspect most other languages that have database connection libraries.<p><em>sqlCL</em> can do it as described in <a href="https://www.thatjeffsmith.com/archive/2020/07/using-sqlcl-to-write-out-blobs-to-files-in-20-lines-of-js/">Using SQLcl to write out BLOBs to files in 20 lines of js</a>; however, as I’ve mentioned in other posts, <em>sqlCL</em> is strangely lacking on every ETL server I’ve had the pleasure of visiting. For that matter the security folk aren’t crazy about having java client programs on servers. I think they overreacted to a security issue from many years ago and have never gotten over it, but it is what it is.<p>This article is about extracting <em>CSV</em> flat files, <em>CLOB</em>’s and <em>BLOB</em>’s from Oracle using <em>Perl</em>.<h1 id="do-you-have-perl-dbdoracle">Do You Have Perl DBD::Oracle?</h1><p>You may not. It does not ship with any OS I know of other than Oracle’s own version of RHL. Neither is it available in any <em>YUM</em> repository I could find, so your Unix Admin is not going to be able to install it easily. They may balk at doing it at all depending on how strict the rules are under which they work.<p>That said, it has gotten easier as I demonstrated in <a href="https://lee-lindley.github.io/oracle/perl/linux/2022/04/28/Perl-DBD-Oracle-RHL.html">Installing Perl DBD::Oracle on RHL</a>. There is a good chance your Unix Admin isn’t allowed to alter the vendor <em>Perl</em>. If that is the case you may need to install your own <em>Perl</em> and add <em>DBD::Oracle</em> to that. Perhaps the Unix admin can do that for you.<blockquote><p>I don’t mean to make light of this, but if you are going to have a useful scripting environment, whether it be <em>Perl</em>, <em>Python</em>, or something else, at some point the security mavens and corporate rule makers need to give you one and it needs to have the database connect libraries linked in. “Of course that’s true” you are thinking. Surprise! You may find the security mavens and IT infrastructure folk are not sympathetic to your need for a decent scripting environment with a built-in Oracle connection library on the ETL server. At one company I encountered a mindset that shell and <em>sqlplus</em>, along with a vendor ETL tool, were all you need. It was a large, sophisticated organization too. They were responding to pressures from senior management that resulted in what I would call unintended consequences.</blockquote><h1 id="running-data-through-perl">Running Data Through Perl</h1><p><em>Perl</em> is fantastic as a scripting language. But like all scripting languages it has some overhead costs. It isn’t the bytecode, which is pretty efficient. The overhead is in the data structures which are fat pigs. If you look at the underlying structure of a <em>Perl</em> <em>scalar</em> variable, you will find multiple pointer and length members. For example it has a place to store an integer, a floating point number, a string, an array, and something called “magic” among other things. There is a lot of wasted space for any given scalar object.<p>Under normal circumstances that hardly matters. If you are running a <em>fetchrow_array</em> operation over a large number of rows on a big <em>SQL</em> query, you are creating and tearing down a scalar for every column on every row. It can really add up.<p>Yeah, don’t do that. You would be better off spooling it out from <em>sqlplus</em>. On the other hand, if you are reading and writing large chunks of data through Perl, the overhead is negligible. The underlying data movement is all handled in tight C code and is efficient.<h1 id="using-dbdoracle-to-read-clobblob-data">Using DBD::Oracle to Read CLOB/BLOB Data</h1><p>In the article <a href="https://lee-lindley.github.io/oracle/sql/plsql/2021/09/10/Ubiquitous-CSV_file.html">The Ubiquitous CSV File</a> I described multiple ways for generating CSV data and getting it out of the database. One of those ways was for the use case that you were doing it for a business user who just turns around and loads it to a spreadsheet. You can up your game by producing an <em>XLSX</em> file directly from the database using <a href="https://github.com/mbleron/ExcelGen">ExcelGen</a>. The output of that is a <em>BLOB</em>.<p>I also have a CSV file generator in package named <em>app_csv_pkg</em> available in <a href="https://github.com/lee-lindley/plsql_utilities#app_csv_pkg">plsql_utilities</a>. I described how it it works in <a href="https://lee-lindley.github.io/oracle/sql/plsql/2021/12/31/Polymorphic-Table-Functions-3.html">Polymorphic Table Function (PTF) for CSV (take 3)</a> The output of that is a <em>CLOB</em>. Well, you can take the output as single column rows in a fetch, but you still have to stream the data out somehow.<p>Given that you have a procedure that can produce a <em>BLOB</em> or <em>CLOB</em> with everything you need to put in the file on the client, how can we get it from the database? Let’s walk through an example.<p>This first part is boilerplate you will have in all of your scripts unless you have refactored it into a connection object, perhaps one that handles the password management.<p>We need the Oracle Type definitions, thus the extra argument to use DBD::Oracle.<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env perl</span>
<span class="k">use</span> <span class="nv">DBI</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">DBD::</span><span class="nv">Oracle</span> <span class="sx">qw(:ora_types)</span><span class="p">;</span>
<span class="k">use</span> <span class="nv">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="nv">warnings</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$dbh</span> <span class="o">=</span> <span class="nv">DBI</span><span class="o">-&gt;</span><span class="nb">connect</span><span class="p">('</span><span class="s1">dbi:Oracle:</span><span class="p">',</span> <span class="p">'</span><span class="s1">lee@rhl1pdb</span><span class="p">',</span> <span class="p">'</span><span class="s1">my secret password</span><span class="p">'</span>
                        <span class="p">,</span> <span class="p">{</span><span class="s">RaiseError</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s">AutoCommit</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">RowCacheSize</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">102400</span><span class="p">,</span> <span class="s">ora_module_name</span> <span class="o">=&gt;</span> <span class="p">'</span><span class="s1">Perl</span><span class="p">'</span> <span class="p">}</span>
                      <span class="p">)</span> <span class="ow">or</span> <span class="nb">die</span> <span class="p">"</span><span class="s2">Database connection not made: DBI::errstr</span><span class="p">";</span>
<span class="nv">$dbh</span><span class="o">-&gt;</span><span class="k">do</span><span class="p">("</span><span class="s2">alter session set nls_date_format = 'mm/dd/yyyy'</span><span class="p">");</span>
</code></pre></div></div><p>Next we prepare our <em>PL/SQL</em> anonymous block. This could have been a call to ExcelGen or your own procedure that produces a <em>BLOB</em> or <em>CLOB</em>. In this case I’m demonstrating with <em>app_csv_pkg</em> where we pass it a query to run as a string. It executes the query, fetches the data, converts it into <em>CSV</em> rows, and concatenates them into a <em>CLOB</em>. It then returns the <em>CLOB</em> as an OUT parameter.<p>The local hash with <em>ora_auto_lob</em> setting to false is so that we get back a <em>LOB</em> locator rather than letting the driver convert the <em>CLOB</em> into one giant string. We might not want to put that much data into memory, plus we have to know in advance how big it could be and set some variables to allow for it. Search the DBD::Oracle perldoc for CLOB and read all about it. Unfortunately, it is a pretty big topic.<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">my</span> <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="nv">prepare</span><span class="p">(</span><span class="sx">q!
    BEGIN
        app_csv_pkg.get_clob(
            p_sql           =&gt; :sql
            ,p_clob         =&gt; :clob
            ,p_rec_count    =&gt; :rec_count
        ); 
    END;
!</span>
    <span class="p">,</span> <span class="p">{</span> <span class="s">ora_auto_lob</span> <span class="o">=&gt;</span> <span class="mi">0</span> <span class="p">}</span> <span class="c1"># this says pass LOB locator, not entire lob</span>
<span class="p">);</span>
</code></pre></div></div><p>Next we create a variable with our query and 2 variables we will bind as OUT parameters. The bind options are important. The <em>SQLT_CHR</em> type will convert a perl string to the proper type for the <em>CLOB</em> input parameter up to about 2MB in size. If your query is bigger than that, you are doing something wrong. If you really need to input a CLOB, read the DBD::Oracle perldoc.<p>The output parameter type <em>ORA_CLOB</em> in this case means we will get back a <em>LOB</em> locator. If in the <em>prepare</em> statement above we had allowed <em>ora_auto_lob</em> to be the default TRUE, we would get back a string (as long as it wasn’t too big).<p><em>rec_count</em> is just a number output parameter. After it runs we can find out how many records the query returned and were placed in our <em>CLOB</em>. Useful for logging.<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">my</span> <span class="nv">$sql</span> <span class="o">=</span> <span class="p">'</span><span class="s1">SELECT * FROM v$reserved_words</span><span class="p">';</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$rec_count</span><span class="p">,</span> <span class="nv">$clob</span><span class="p">);</span>

<span class="nv">$sth</span><span class="o">-&gt;</span><span class="nv">bind_param</span><span class="p">(</span> <span class="p">'</span><span class="s1">:sql</span><span class="p">',</span> <span class="nv">$sql</span><span class="p">,</span> <span class="p">{</span><span class="s">ora_type</span> <span class="o">=&gt;</span> <span class="nv">SQLT_CHR</span> <span class="p">}</span> <span class="p">);</span> <span class="c1"># This type converts to CLOB on input up to 2MB which is plenty</span>
<span class="nv">$sth</span><span class="o">-&gt;</span><span class="nv">bind_param_inout</span><span class="p">(</span> <span class="p">'</span><span class="s1">:clob</span><span class="p">',</span> <span class="o">\</span><span class="nv">$clob</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s">ora_type</span> <span class="o">=&gt;</span> <span class="nv">ORA_CLOB</span> <span class="p">}</span> <span class="p">);</span> <span class="c1"># will be a CLOB locator</span>
<span class="nv">$sth</span><span class="o">-&gt;</span><span class="nv">bind_param_inout</span><span class="p">(</span> <span class="p">'</span><span class="s1">:rec_count</span><span class="p">',</span> <span class="o">\</span><span class="nv">$rec_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nv">$sth</span><span class="o">-&gt;</span><span class="nv">execute</span><span class="p">;</span>
</code></pre></div></div><p>After the <em>execute</em>, <em>$rec_count</em> has the number of rows which we can report and <em>$clob</em> has a <em>LOB</em> locator (which is only good to use during this transaction; a <em>commit</em> or <em>rollback</em> destroys the underlying <em>LOB</em>.)<p>Now we write out the data. We are writing to STDOUT here, but you could have opened a named file and be writing to that.<p>Rather than bring back the entire CLOB into one huge chunk of memory, we will read and write it in pieces. Each of these is a round trip to the database so do not make them too small, but neither do we want to use so much memory on both sides of the connection that it is an issue. Just like where Oracle has a rule of thumb that 100 rows is a good bulk fetch size, the right answer is probably below 1MB and more than 10K. I don’t really know where the sweet spot is without some experimentation. Here I picked 256K bytes.<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span> <span class="bp">STDERR</span> <span class="nv">$rec_count</span><span class="p">,</span> <span class="p">"</span><span class="s2"> rows returned in clob</span><span class="se">\n</span><span class="p">";</span>

<span class="c1"># 256K chunks are not that much memory, but still big enough perl scalar creation/destruction not an issue</span>
<span class="k">my</span> <span class="nv">$chunk_size</span><span class="o">=</span><span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span> 
<span class="k">my</span> <span class="nv">$offset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1"># starts at 1, not 0</span>
<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="nv">ora_lob_read</span><span class="p">(</span> <span class="nv">$clob</span><span class="p">,</span> <span class="nv">$offset</span><span class="p">,</span> <span class="nv">$chunk_size</span> <span class="p">);</span>
    <span class="k">last</span> <span class="k">unless</span> <span class="nb">length</span> <span class="nv">$data</span><span class="p">;</span>
    <span class="k">print</span> <span class="nv">$data</span><span class="p">;</span>
    <span class="nv">$offset</span> <span class="o">+=</span> <span class="nv">$chunk_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$dbh</span><span class="o">-&gt;</span><span class="nv">rollback</span><span class="p">;</span> <span class="c1"># to end the transaction concerning temp lob locator and freeing it so perl destructor doesn't complain</span>
</code></pre></div></div><p>I’m not going to print out the results, but this works just fine. My sample query output is not bigger than the chunk size, so it didn’t loop at first. I had to make it smaller and put in some debug prints to prove it, but it works.<h1 id="conclusion">Conclusion</h1><p>I’ve waved my hands around a lot in prior articles saying you can get <em>CLOB</em> and <em>BLOB</em> data out on the client. I showed it with <em>sqlplus</em> and <em>sqlCL</em>. I have used Tom Kyte’s <em>flat</em> utility for years (though the security mavens don’t want me near a C compiler and Devops won’t give me a deploy method for it). It was time to put up some proof that we can do it all with a scripting language efficiently too. Here ya’ go.<p>Hope this helps.</div></div><div class="panel-body"><h4>Related Posts</h4><ul><li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/perl/2022/11/13/version_db_objects.html">Versioning Oracle Code from Open Source</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/perl">perl</a>)<li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/sql/2022/10/09/antijoins_with_or.html">Tuning Query with OR Conditions in a NOT EXISTS</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/sql">sql</a>)<li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/plsql/2022/09/18/spreadsheets_with_plsql.html">Manipulating XLSX Spreadsheets in PL/SQL</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/plsql">plsql</a>)<li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/plsql/sql/vim/2022/04/29/vim-plsql-syntax.html">Syntax Highlighting for PL/SQL in vim</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/plsql">plsql</a>, <a href="/category/sql">sql</a>, <a href="/category/vim">vim</a>)<li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/perl/linux/2022/04/28/Perl-DBD-Oracle-RHL.html">Installing Perl DBD::Oracle on RHL</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/perl">perl</a>, <a href="/category/linux">linux</a>)<li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/sql/plsql/2022/04/10/hierarchical-profiler-context-switch.html">Profiling PL/SQL to Examine Context Switch Penalty</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/sql">sql</a>, <a href="/category/plsql">plsql</a>)</ul></div><div class="PageNavigation"> <a class="prev" href="/oracle/plsql/sql/vim/2022/04/29/vim-plsql-syntax.html">&laquo; Syntax Highlighting for PL/SQL in vim</a> <a class="next" href="/oracle/plsql/2022/09/18/spreadsheets_with_plsql.html">Manipulating XLSX Spreadsheets in PL/SQL &raquo;</a></div><div class="disqus-comments"><div id="disqus_thread"></div><script type="text/javascript"> /* <![CDATA[ */ var disqus_shortname = "leelindleyscratchpad"; var disqus_identifier = "https://lee-lindley.github.io_Using Perl DBD::Oracle to write LOB content"; var disqus_title = "Using Perl DBD::Oracle to write LOB content"; /* * * DON'T EDIT BELOW THIS LINE * * */ (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); /* ]]> */ </script></div><footer> &copy; Lee Lindley - <a href="https://github.com/lee-lindley">https://github.com/lee-lindley</a> - Powered by Jekyll.<div class="btn-github" style="float:right;"> <iframe src="https://ghbtns.com/github-btn.html?user=agusmakmun&repo=agusmakmun.github.io&type=star&count=true" frameborder="0" scrolling="0" width="100" height="20px"></iframe> <iframe src="https://ghbtns.com/github-btn.html?user=agusmakmun&repo=agusmakmun.github.io&type=fork&count=true" frameborder="0" scrolling="0" width="100" height="20px"></iframe></div></footer></div></div><script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script> <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script> <script src="/static/js/bootstrap.min.js"></script> <script src="/static/js/super-search.js"></script> <script src="/static/js/thickbox-compressed.js"></script> <script src="/static/js/projects.js"></script>
