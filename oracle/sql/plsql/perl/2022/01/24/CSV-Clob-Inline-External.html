<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="shortcut icon" href="/static/img/favicon.ico" /><title>Inline External Tables for CSV Load - Lee Lindley Scratchpad</title><meta name="author" content="Lee Lindley" /><meta name="description" content="Inline External Tables for CSV Load" /><meta name="keywords" content="Inline External Tables for CSV Load, Lee Lindley Scratchpad, oracle, sql, plsql, perl" /><link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml"><meta content="" property="fb:app_id"><meta content="Lee Lindley Scratchpad" property="og:site_name"><meta content="Inline External Tables for CSV Load" property="og:title"><meta content="article" property="og:type"><meta content="Posts on Technical Subjects, mostly Oracle and Linux" property="og:description"><meta content="https://lee-lindley.github.io/oracle/sql/plsql/perl/2022/01/24/CSV-Clob-Inline-External.html" property="og:url"><meta content="2022-01-24T10:30:00-05:00" property="article:published_time"><meta content="https://lee-lindley.github.io/about/" property="article:author"><meta content="oracle" property="article:section"><meta content="oracle" property="article:tag"><meta content="sql" property="article:tag"><meta content="plsql" property="article:tag"><meta content="csv" property="article:tag"><meta content="perl" property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@"><meta name="twitter:creator" content="@"><meta name="twitter:title" content="Inline External Tables for CSV Load"><meta name="twitter:url" content="https://lee-lindley.github.io/oracle/sql/plsql/perl/2022/01/24/CSV-Clob-Inline-External.html"><meta name="twitter:description" content="Posts on Technical Subjects, mostly Oracle and Linux"><link href="/static/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous"><link rel="stylesheet" href="/static/css/syntax.css"><link href="/static/css/bootstrap.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:400,300italic,300,400italic,700&amp;subset=latin,latin-ext" rel="stylesheet" type="text/css"><link rel="stylesheet" href="/static/css/super-search.css"><link rel="stylesheet" href="/static/css/thickbox.css"><link rel="stylesheet" href="/static/css/projects.css"><link rel="stylesheet" href="/static/css/main.css"><body><div class="container"><div class="col-sm-3"><div class="fixed-condition"><h1 class="author-name"><a href="/">Lee Lindley</a></h1><div class="profile-about"> I'm Just Another Perl Hacker who wound up in a big Oracle Database playground</div><div class="social"><ul><li><a href="https://linkedin.com/in/lee-lindley" target="_blank"><i class="fa fa-linkedin"></i></a><li><a href="https://github.com/lee-lindley" target="_blank"><i class="fa fa-github"></i></a></ul></div><div class="search" id="js-search"> <input type="text" placeholder="(sitemap)~$ type to search" class="search__input form-control" id="js-search__input"><ul class="search__results" id="js-search__results"></ul></div><hr /><ul class="sidebar-nav"> <strong>Navigation</strong><li><a href="/">Home</a><li><a class="about" href="/about/">About Me</a><li><a class="about" href="/projects/">My Projects</a><li><a class="about" href="/feed.xml">XML Feed</a></ul></div></div><div class="col-sm-8 col-offset-1 main-layout"><header class="post-header"><h1 class="post-title">Inline External Tables for CSV Load</h1></header><span class="time">24 Jan 2022</span> <span class="categories"> &raquo; <a href="/category/oracle">oracle</a>, <a href="/category/sql">sql</a>, <a href="/category/plsql">plsql</a>, <a href="/category/perl">perl</a> </span><div class="content"><div class="post"><h1 id="yet-another-csv-load-option---inline-external-tables">Yet Another CSV Load Option - <em>Inline External Tables</em></h1><p>While reviewing the Oracle What’s New documentation for 18c I found <em>Private Temporary Tables</em> which I wrote about in <a href="https://lee-lindley.github.io/oracle/sql/plsql/perl/2022/01/23/CSV-Clob-PTT.html">my last post</a> on the neverending saga of loading CSV data. Also found in What’s New for 18c is <em>Inline External Tables</em>.<p>Just like with PTTs, <em>Inline External Tables</em> are DDL without the downside. It is ad-hoc, and can be dynamically generated. In order to use it you must have an Oracle DIRECTORY object granted to you with both READ and WRITE, plus EXECUTE privilege on <em>DBMS_LOB</em> (and <em>UTL_FILE</em> if you want to clean up after yourself).<h1 id="example">Example</h1><p>From our last post we had an example of CSV data with a header row that looked as such:<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Employee ID, Last Name, First Name, nickname
999, "Baggins", "Bilbo", "badboy, ringbearer"
998, "Baggins", "Frodo",
997, "Orc", "Ogg", "i kill you"
</code></pre></div></div><p>We could get fancy and try to parse the header row like we did last time, but for this effort I’m going the cheap route and assume you, the developer who wants to load the CSV data, will hand craft the code.<h1 id="create-file-on-oracle-server">Create File on Oracle Server</h1><div class="language-plsql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">BEGIN</span>
    <span class="n">DBMS_LOB</span><span class="p">.</span><span class="n">clob2file</span><span class="p">(</span><span class="o">q'[</span><span class="sx">999, "Baggins", "Bilbo", "badboy, ringbearer"
998, "Baggins", "Frodo",
997, "Orc", "Ogg", "i kill you"</span><span class="o">]'</span>
                        <span class="p">,</span><span class="o">'</span><span class="s1">TMP_DIR</span><span class="o">'</span>
                        <span class="p">,</span><span class="o">'</span><span class="s1">temp_csv_load.csv</span><span class="o">'</span>
    <span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
<span class="o">/</span>
</code></pre></div></div><h1 id="read-from-the-inline-external-table">Read from the Inline External Table</h1><p>Now we read from the file:<div class="language-plsql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kr">SELECT</span> <span class="o">*</span>
    <span class="kr">FROM</span> <span class="k">EXTERNAL</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="o">"</span><span class="nv">Employee ID</span><span class="o">"</span>   <span class="kt">VARCHAR2</span><span class="p">(</span><span class="mi">4000</span><span class="p">)</span>
            <span class="p">,</span><span class="o">"</span><span class="nv">Last Name</span><span class="o">"</span>    <span class="kt">VARCHAR2</span><span class="p">(</span><span class="mi">4000</span><span class="p">)</span>
            <span class="p">,</span><span class="o">"</span><span class="nv">First Name</span><span class="o">"</span>   <span class="kt">VARCHAR2</span><span class="p">(</span><span class="mi">4000</span><span class="p">)</span>
            <span class="p">,</span><span class="o">"</span><span class="nv">nickname</span><span class="o">"</span>     <span class="kt">VARCHAR2</span><span class="p">(</span><span class="mi">4000</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">TYPE</span> <span class="n">ORACLE_LOADER</span>
        <span class="kr">DEFAULT</span> <span class="k">DIRECTORY</span> <span class="n">TMP_DIR</span>
        <span class="k">ACCESS</span> <span class="k">PARAMETERS</span> <span class="p">(</span>
            <span class="n">RECORDS</span> <span class="n">DELIMITED</span> <span class="kr">BY</span> <span class="n">NEWLINE</span>
            <span class="n">FIELDS</span> <span class="n">TERMINATED</span> <span class="kr">BY</span> <span class="o">'</span><span class="s1">,</span><span class="o">'</span> 
            <span class="n">OPTIONALLY</span> <span class="n">ENCLOSED</span> <span class="kr">BY</span> <span class="o">'</span><span class="s1">"</span><span class="o">'</span>
            <span class="k">MISSING</span> <span class="n">FIELD</span> <span class="kr">VALUES</span> <span class="n">ARE</span> <span class="kr">NULL</span>
        <span class="p">)</span>
        <span class="k">LOCATION</span> <span class="p">(</span><span class="o">'</span><span class="s1">temp_csv_load.csv</span><span class="o">'</span><span class="p">)</span>
        <span class="k">REJECT</span> <span class="k">LIMIT</span> <span class="k">UNLIMITED</span>
    <span class="p">)</span> <span class="n">temp_csv_load_ext</span>
    <span class="p">;</span>
</code></pre></div></div><p>The export from SQL Developer is adding the double quotes here. These are not in the data.<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"Employee ID"                 "Last Name"                   "First Name"                  "nickname"                    
"999"                         "Baggins"                     "Bilbo"                       "badboy, ringbearer"          
"998"                         "Baggins"                     "Frodo"                       ""                            
"997"                         "Orc"                         "Ogg"                         "i kill you"                  
</code></pre></div></div><p>You could of course have the external table sqlldr driver convert to dates and numbers as needed. As far as I can tell you have everything at your disposal that is there for a normal external table.<p>The line<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>OPTIONALLY ENCLOSED BY '"'
</code></pre></div></div><p>makes sqlldr parse CSV data in a way that I believe mostly comports with the RFC on CSV data. It will handle most of the test cases I threw at it and you are unlikely to give it the oddball stuff.<p>The line<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MISSING FIELD VALUES ARE NULL
</code></pre></div></div><p>is because we do not have a trailing comma after the last field (which would be delimited data rather than separated) and because the sqlldr syntax of ‘TRAILING NULLCOLS’ I would pick is not available in the external table driver. Maddening. Without it our second record would fail to load.<h1 id="cleanup">Cleanup</h1><p>Being a good citizen, we remove our trash:<div class="language-plsql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">BEGIN</span>
    <span class="n">UTL_FILE</span><span class="p">.</span><span class="n">fremove</span><span class="p">(</span><span class="o">'</span><span class="s1">TMP_DIR</span><span class="o">'</span><span class="p">,</span><span class="o">'</span><span class="s1">temp_csv_load.csv</span><span class="o">'</span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
<span class="o">/</span>
</code></pre></div></div><h1 id="drawback">Drawback</h1><p>The big drawback to this technique (aside from how hard it is to get the external table definition right) is that it requires you have READ/WRITE privs on a directory on the database server. In many organizations this is forbidden. I retrofitted forty something load jobs from external table to sqlldr because of that restriction imposed upon us by architecture/DBA teams a few years back. We can debate whether that is reasonable or not, but it is what it is.<h1 id="conclusion">Conclusion</h1><p>There are plenty of client tools that will generate load data for you from CSV files or even directly from Excel. As nice as those are, you probably cannot use them for Continuous Improvement deployments. I’m trying to come up with a way to make that better. This is one more technique we might be able to use.</div></div><div class="panel-body"><h4>Related Posts</h4><ul><li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/perl/2022/04/30/perl_dbd_oracle_clob.html">Using Perl DBD::Oracle to write LOB content</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/perl">perl</a>)<li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/plsql/sql/vim/2022/04/29/vim-plsql-syntax.html">Syntax Highlighting for PL/SQL in vim</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/plsql">plsql</a>, <a href="/category/sql">sql</a>, <a href="/category/vim">vim</a>)<li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/perl/linux/2022/04/28/Perl-DBD-Oracle-RHL.html">Installing Perl DBD::Oracle on RHL</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/perl">perl</a>, <a href="/category/linux">linux</a>)<li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/sql/plsql/2022/04/10/hierarchical-profiler-context-switch.html">Profiling PL/SQL to Examine Context Switch Penalty</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/sql">sql</a>, <a href="/category/plsql">plsql</a>)<li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/sql/plsql/2022/04/10/Regexp_instr-Beginning-of-line-anchor.html">Oracle REGEXP_INSTR and Beginning of Line Anchor</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/sql">sql</a>, <a href="/category/plsql">plsql</a>)<li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/sql/plsql/2022/04/02/Object-Methods-in-SQL.html">Cost of UDT Object Methods in SQL</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/sql">sql</a>, <a href="/category/plsql">plsql</a>)</ul></div><div class="PageNavigation"> <a class="prev" href="/oracle/sql/plsql/perl/2022/01/23/CSV-Clob-PTT.html">&laquo; CSV Clob and Private Temporary Table</a> <a class="next" href="/oracle/sql/2022/03/06/Staging_Tables_vs_With.html">Staging Tables vs Single SQL &raquo;</a></div><div class="disqus-comments"><div id="disqus_thread"></div><script type="text/javascript"> /* <![CDATA[ */ var disqus_shortname = "leelindleyscratchpad"; var disqus_identifier = "https://lee-lindley.github.io_Inline External Tables for CSV Load"; var disqus_title = "Inline External Tables for CSV Load"; /* * * DON'T EDIT BELOW THIS LINE * * */ (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); /* ]]> */ </script></div><footer> &copy; Lee Lindley - <a href="https://github.com/lee-lindley">https://github.com/lee-lindley</a> - Powered by Jekyll.<div class="btn-github" style="float:right;"> <iframe src="https://ghbtns.com/github-btn.html?user=agusmakmun&repo=agusmakmun.github.io&type=star&count=true" frameborder="0" scrolling="0" width="100" height="20px"></iframe> <iframe src="https://ghbtns.com/github-btn.html?user=agusmakmun&repo=agusmakmun.github.io&type=fork&count=true" frameborder="0" scrolling="0" width="100" height="20px"></iframe></div></footer></div></div><script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script> <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script> <script src="/static/js/bootstrap.min.js"></script> <script src="/static/js/super-search.js"></script> <script src="/static/js/thickbox-compressed.js"></script> <script src="/static/js/projects.js"></script>
