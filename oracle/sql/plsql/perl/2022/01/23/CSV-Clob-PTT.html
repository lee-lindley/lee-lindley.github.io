<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="shortcut icon" href="/static/img/favicon.ico" /><title>CSV Clob and Private Temporary Table - Lee Lindley Scratchpad</title><meta name="author" content="Lee Lindley" /><meta name="description" content="CSV Clob and Private Temporary Table" /><meta name="keywords" content="CSV Clob and Private Temporary Table, Lee Lindley Scratchpad, oracle, sql, plsql, perl" /><link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml"><meta content="" property="fb:app_id"><meta content="Lee Lindley Scratchpad" property="og:site_name"><meta content="CSV Clob and Private Temporary Table" property="og:title"><meta content="article" property="og:type"><meta content="Posts on Technical Subjects, mostly Oracle and Linux" property="og:description"><meta content="https://lee-lindley.github.io/oracle/sql/plsql/perl/2022/01/23/CSV-Clob-PTT.html" property="og:url"><meta content="2022-01-23T10:30:00-05:00" property="article:published_time"><meta content="https://lee-lindley.github.io/about/" property="article:author"><meta content="oracle" property="article:section"><meta content="oracle" property="article:tag"><meta content="sql" property="article:tag"><meta content="plsql" property="article:tag"><meta content="csv" property="article:tag"><meta content="perl" property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@"><meta name="twitter:creator" content="@"><meta name="twitter:title" content="CSV Clob and Private Temporary Table"><meta name="twitter:url" content="https://lee-lindley.github.io/oracle/sql/plsql/perl/2022/01/23/CSV-Clob-PTT.html"><meta name="twitter:description" content="Posts on Technical Subjects, mostly Oracle and Linux"><link href="/static/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous"><link rel="stylesheet" href="/static/css/syntax.css"><link href="/static/css/bootstrap.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:400,300italic,300,400italic,700&amp;subset=latin,latin-ext" rel="stylesheet" type="text/css"><link rel="stylesheet" href="/static/css/super-search.css"><link rel="stylesheet" href="/static/css/thickbox.css"><link rel="stylesheet" href="/static/css/projects.css"><link rel="stylesheet" href="/static/css/main.css"><body><div class="container"><div class="col-sm-3"><div class="fixed-condition"><h1 class="author-name"><a href="/">Lee Lindley</a></h1><div class="profile-about"> I'm Just Another Perl Hacker who wound up in a big Oracle Database playground</div><div class="social"><ul><li><a href="https://linkedin.com/in/lee-lindley" target="_blank"><i class="fa fa-linkedin"></i></a><li><a href="https://github.com/lee-lindley" target="_blank"><i class="fa fa-github"></i></a></ul></div><div class="search" id="js-search"> <input type="text" placeholder="(sitemap)~$ type to search" class="search__input form-control" id="js-search__input"><ul class="search__results" id="js-search__results"></ul></div><hr /><ul class="sidebar-nav"> <strong>Navigation</strong><li><a href="/">Home</a><li><a class="about" href="/about/">About Me</a><li><a class="about" href="/projects/">My Projects</a><li><a class="about" href="/feed.xml">XML Feed</a></ul></div></div><div class="col-sm-8 col-offset-1 main-layout"><header class="post-header"><h1 class="post-title">CSV Clob and Private Temporary Table</h1></header><span class="time">23 Jan 2022</span> <span class="categories"> &raquo; <a href="/category/oracle">oracle</a>, <a href="/category/sql">sql</a>, <a href="/category/plsql">plsql</a>, <a href="/category/perl">perl</a> </span><div class="content"><div class="post"><h1 id="deploying-table-data-using-csv">Deploying Table Data Using CSV</h1><p>I have been obsessing about parsing CSV data with a focus on the use case of code promotion through Continuous Improvement/Devops process. The current method of deploying a bunch of single INSERT statements rubs me the wrong way. It is ridiculous.<p>I get the feeling I’m the only one who cares, but hey, I’m the one who matters!<p>In <a href="https://lee-lindley.github.io/oracle/sql/plsql/perl/2022/01/09/More-CSV-Fun.html">my last post on the topic</a> I described how one could use some new tools I created in <a href="https://github.com/lee-lindley/plsql_utilities#perlish_util_udt">perlish_util_udt</a> to parse a CSV clob into records and fields, then use that parsed data in a SQL statement, perhaps including DML.<p>That blog post left it still a bit rough though. The user would need to remember or relearn the syntax for two related functions to do the parsing, and the syntax for using an object method in a SQL query is easy to forget about or mess up.<p>I had also been experimenting with Polymorphic Table Functions for this purpose because you can determine the resultset structure at run time, which is important for this task. Yet PTFs are complicated. Maybe too complicated.<p>I was rereading the “What’s New” Oracle documentation for the last several releases and Private Temporary Tables (added in 18c) caught my eye. Much of the issue we face with this use case is that it needs to be dynamic and DDL is not dynamic. It is resource expensive and regulated in most production environments. Private Temporary Tables are DDL without the downside. It does not alter the data dictionary (well, maybe there is something going on as it take advantage of the TEMPORARY tablespace), it does not leave anything behind after a session completes, and it is not regulated by our corporate rules.<p>Private Temporary Tables let us define our column list on the fly!<h1 id="perlish_util_udtcreate_ptt_csv">perlish_util_udt.create_ptt_csv</h1><p>This static procedure recently added to <a href="https://github.com/lee-lindley/plsql_utilities#perlish_util_udt">perlish_util_udt</a> combines the operations demonstrated in my prior blog post about CSV data to build and populate a Private Temporary Table to contain your data from the CSV clob. How cool is that?<h2 id="example">Example</h2><div class="language-plsql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">BEGIN</span>
    <span class="n">perlish_util_udt</span><span class="p">.</span><span class="n">create_ptt_csv</span><span class="p">(</span><span class="o">'</span><span class="s1">Employee ID, Last Name, First Name, nickname
999, "Baggins", "Bilbo", "badboy, ringbearer"
998, "Baggins", "Frodo",
997, "Orc", "Ogg", "i kill you"</span><span class="o">'</span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
<span class="o">/</span>
<span class="kr">select</span> <span class="o">"</span><span class="nv">Employee ID</span><span class="o">"</span><span class="p">,</span> <span class="o">"</span><span class="nv">Last Name</span><span class="o">"</span><span class="p">,</span> <span class="o">"</span><span class="nv">First Name</span><span class="o">"</span><span class="p">,</span> <span class="o">"</span><span class="nv">nickname</span><span class="o">"</span>
<span class="kr">FROM</span> <span class="n">ora$ptt_csv</span>
<span class="p">;</span>
</code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"Employee ID"                 "Last Name"                   "First Name"                  "nickname"                    
"999"                         "Baggins"                     "Bilbo"                       "badboy, ringbearer"          
"998"                         "Baggins"                     "Frodo"                       ""                            
"997"                         "Orc"                         "Ogg"                         "i kill you"                  
</code></pre></div></div><p>The value of “nickname” in the Fodo record is NULL.<p>That is a lot easier than doing the parsing into lines and the parsing into fields and selecting by index number we were using before. Under the covers that is what it does, but now we have something that is easy to use.<h2 id="the-code">The Code</h2><p>Given the prior work with <em>perlish_util_udt.split_clobs_to_lines</em> and <em>perlish_util_udt.split_csv</em>, this was not difficult to implement.<div class="language-plsql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="k">STATIC</span> <span class="k">PROCEDURE</span> <span class="n">create_ptt_csv</span> <span class="p">(</span>
         <span class="c1">-- creates private temporary table ora$ptt_csv with columns named in first row of data case preserved.</span>
         <span class="c1">-- All fields are varchar2(4000)</span>
	     <span class="n">p_clob</span>         <span class="kt">CLOB</span>
	    <span class="p">,</span><span class="n">p_separator</span>    <span class="kt">VARCHAR2</span>    <span class="kr">DEFAULT</span> <span class="o">'</span><span class="s1">,</span><span class="o">'</span>
	    <span class="p">,</span><span class="n">p_strip_dquote</span> <span class="kt">VARCHAR2</span>    <span class="kr">DEFAULT</span> <span class="o">'</span><span class="s1">Y</span><span class="o">'</span> <span class="c1">-- also unquotes \" and "" pairs within the field to just "</span>
	<span class="p">)</span> <span class="kr">IS</span>
        <span class="n">v_rows</span>      <span class="n">arr_varchar2_udt</span> <span class="o">:=</span> <span class="n">perlish_util_udt</span><span class="p">.</span><span class="n">split_clob_to_lines</span><span class="p">(</span><span class="n">p_clob</span><span class="p">);</span>
        <span class="n">v_cols</span>      <span class="n">perlish_util_udt</span><span class="p">;</span>
</code></pre></div></div><p>The first step, which is in the variable declarations, splits the clob up into an array of rows. We are going to parse the first row into <em>v_cols</em> which we make into an object type so we can take advantage of our <em>map</em> and <em>join</em> methods to build the SQL we need to execute.<div class="language-plsql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">v_sql</span>       <span class="kt">CLOB</span><span class="p">;</span>
    <span class="k">BEGIN</span>
        <span class="n">v_cols</span> <span class="o">:=</span> <span class="n">perlish_util_udt</span><span class="p">(</span><span class="n">perlish_util_udt</span><span class="p">.</span><span class="n">split_csv</span><span class="p">(</span><span class="n">v_rows</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">p_separator</span> <span class="o">=&gt;</span> <span class="n">p_separator</span><span class="p">,</span> <span class="n">p_strip_dquote</span> <span class="o">=&gt;</span> <span class="o">'</span><span class="s1">Y</span><span class="o">'</span><span class="p">));</span>
        <span class="c1">-- remove the header row so can bind the array to read the data</span>
        <span class="n">v_rows</span><span class="p">.</span><span class="n">DELETE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</code></pre></div></div><p>We parse the first row differently than the rest. We are going to enclose the data in double quotes so we must strip them if they exist. After we get our data from the first row, we delete it from the collection. We will later bind the collection array to a SQL statement and do not want the first row to be present.<div class="language-plsql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">v_sql</span> <span class="o">:=</span> <span class="o">'</span><span class="s1">DROP TABLE ora$ptt_csv</span><span class="o">'</span><span class="p">;</span>
        <span class="k">BEGIN</span>
            <span class="k">EXECUTE</span> <span class="k">IMMEDIATE</span> <span class="n">v_sql</span><span class="p">;</span>
        <span class="k">EXCEPTION</span> <span class="k">WHEN</span> <span class="k">OTHERS</span> <span class="kr">THEN</span> <span class="kr">NULL</span><span class="p">;</span>
        <span class="k">END</span><span class="p">;</span>
</code></pre></div></div><p>Drop the PTT if it already exists.<div class="language-plsql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">v_sql</span> <span class="o">:=</span> <span class="o">'</span><span class="s1">CREATE PRIVATE TEMPORARY TABLE ora$ptt_csv(
</span><span class="o">'</span>
            <span class="o">||</span><span class="n">v_cols</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">'</span><span class="s1">"$_"    VARCHAR2(4000)</span><span class="o">'</span><span class="p">).</span><span class="n">join</span><span class="p">(</span><span class="o">'</span><span class="s1">
,</span><span class="o">'</span><span class="p">)</span>
            <span class="o">||'</span><span class="s1">
)</span><span class="o">'</span>
            <span class="p">;</span>
        <span class="n">DBMS_OUTPUT</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="n">v_sql</span><span class="p">);</span>
        <span class="k">EXECUTE</span> <span class="k">IMMEDIATE</span> <span class="n">v_sql</span><span class="p">;</span>
</code></pre></div></div><p>We use our collection of column names from the first row to create the column defintions for the PTT. <em>map</em> and <em>join</em> are handy for this. As you can see we do not try to figure out what kind of data each column is. We just stuff each column value into a VARCHAR2(4000) field.<p>The serveroutput of this code from running the example above was:<div class="language-plsql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">CREATE</span> <span class="k">PRIVATE</span> <span class="k">TEMPORARY</span> <span class="kr">TABLE</span> <span class="n">ora$ptt_csv</span><span class="p">(</span>
<span class="o">"</span><span class="nv">Employee ID</span><span class="o">"</span>    <span class="kt">VARCHAR2</span><span class="p">(</span><span class="mi">4000</span><span class="p">)</span>
<span class="p">,</span><span class="o">"</span><span class="nv">Last Name</span><span class="o">"</span>    <span class="kt">VARCHAR2</span><span class="p">(</span><span class="mi">4000</span><span class="p">)</span>
<span class="p">,</span><span class="o">"</span><span class="nv">First Name</span><span class="o">"</span>    <span class="kt">VARCHAR2</span><span class="p">(</span><span class="mi">4000</span><span class="p">)</span>
<span class="p">,</span><span class="o">"</span><span class="nv">nickname</span><span class="o">"</span>    <span class="kt">VARCHAR2</span><span class="p">(</span><span class="mi">4000</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div><p>Now for the INSERT.<div class="language-plsql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">v_sql</span> <span class="o">:=</span> <span class="o">q'[</span><span class="sx">INSERT INTO ora$ptt_csv 
WITH a AS (
    SELECT perlish_util_udt(
            perlish_util_udt.split_csv(t.column_value, p_separator =&gt; :p_separator, p_strip_dquote =&gt; :p_strip_dquote, p_keep_nulls =&gt; 'Y')
        ) AS p
    FROM TABLE(:bind_array) t
) SELECT </span><span class="o">]'</span>
        <span class="o">||</span><span class="n">v_cols</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">'</span><span class="s1">x.p.get($##index_val##) AS "$_"</span><span class="o">'</span><span class="p">).</span><span class="n">join</span><span class="p">(</span><span class="o">'</span><span class="s1">
,</span><span class="o">'</span><span class="p">)</span>
        <span class="o">||'</span><span class="s1">
FROM a x</span><span class="o">'</span><span class="p">;</span>
        <span class="c1">-- must use table alias and fully qualify object name with it to be able to call function or get attribute of object</span>
        <span class="c1">-- Thus alias x for a.</span>
        <span class="n">DBMS_OUTPUT</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="n">v_sql</span><span class="p">);</span>
        <span class="k">EXECUTE</span> <span class="k">IMMEDIATE</span> <span class="n">v_sql</span> <span class="k">USING</span> <span class="n">p_separator</span><span class="p">,</span> <span class="n">p_strip_dquote</span><span class="p">,</span> <span class="n">v_rows</span><span class="p">;</span>

    <span class="k">END</span> <span class="c1">-- crate_ptt_csv</span>
    <span class="p">;</span>
</code></pre></div></div><p>Building the INSERT statement was a little tricky because we need to use the object function <em>get</em> with the array index value for each column. Once again <em>map</em> and <em>join</em> are handing for building this. I added the ‘$##index_val##’ substitution to <em>map</em> for this release.<p>The serveroutput of this section from the example:<div class="language-plsql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">INSERT</span> <span class="kr">INTO</span> <span class="n">ora$ptt_csv</span>
<span class="kr">WITH</span> <span class="n">a</span> <span class="kr">AS</span> <span class="p">(</span>
    <span class="kr">SELECT</span> <span class="n">perlish_util_udt</span><span class="p">(</span>
            <span class="n">perlish_util_udt</span><span class="p">.</span><span class="n">split_csv</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">column_value</span><span class="p">,</span> <span class="n">p_separator</span> <span class="o">=&gt;</span> <span class="p">:</span><span class="n">p_separator</span><span class="p">,</span> <span class="n">p_strip_dquote</span> <span class="o">=&gt;</span> <span class="p">:</span><span class="n">p_strip_dquote</span><span class="p">,</span> <span class="n">p_keep_nulls</span> <span class="o">=&gt;</span> <span class="o">'</span><span class="s1">Y</span><span class="o">'</span><span class="p">)</span>
        <span class="p">)</span> <span class="kr">AS</span> <span class="n">p</span>
    <span class="kr">FROM</span> <span class="kr">TABLE</span><span class="p">(:</span><span class="n">bind_array</span><span class="p">)</span> <span class="n">t</span>
<span class="p">)</span> <span class="kr">SELECT</span> <span class="n">x</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="kr">AS</span> <span class="o">"</span><span class="nv">Employee ID</span><span class="o">"</span>
<span class="p">,</span><span class="n">x</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="kr">AS</span> <span class="o">"</span><span class="nv">Last Name</span><span class="o">"</span>
<span class="p">,</span><span class="n">x</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="kr">AS</span> <span class="o">"</span><span class="nv">First Name</span><span class="o">"</span>
<span class="p">,</span><span class="n">x</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="kr">AS</span> <span class="o">"</span><span class="nv">nickname</span><span class="o">"</span>
<span class="kr">FROM</span> <span class="n">a</span> <span class="n">x</span>
</code></pre></div></div><p>And of course you have seen the results. I’m starting to like this. Sure, I’ve been seduced by the dark side and am writing PL/SQL code that looks like Perl, but I am what I am.</div></div><div class="panel-body"><h4>Related Posts</h4><ul><li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/plsql/2022/09/18/spreadsheets_with_plsql.html">Manipulating XLSX Spreadsheets in PL/SQL</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/plsql">plsql</a>)<li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/perl/2022/04/30/perl_dbd_oracle_clob.html">Using Perl DBD::Oracle to write LOB content</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/perl">perl</a>)<li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/plsql/sql/vim/2022/04/29/vim-plsql-syntax.html">Syntax Highlighting for PL/SQL in vim</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/plsql">plsql</a>, <a href="/category/sql">sql</a>, <a href="/category/vim">vim</a>)<li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/perl/linux/2022/04/28/Perl-DBD-Oracle-RHL.html">Installing Perl DBD::Oracle on RHL</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/perl">perl</a>, <a href="/category/linux">linux</a>)<li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/sql/plsql/2022/04/10/hierarchical-profiler-context-switch.html">Profiling PL/SQL to Examine Context Switch Penalty</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/sql">sql</a>, <a href="/category/plsql">plsql</a>)<li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/sql/plsql/2022/04/10/Regexp_instr-Beginning-of-line-anchor.html">Oracle REGEXP_INSTR and Beginning of Line Anchor</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/sql">sql</a>, <a href="/category/plsql">plsql</a>)</ul></div><div class="PageNavigation"> <a class="prev" href="/oracle/sql/plsql/2022/01/22/Hiding-Data-Oracle.html">&laquo; Protecting/Hiding Data in Oracle</a> <a class="next" href="/oracle/sql/plsql/perl/2022/01/24/CSV-Clob-Inline-External.html">Inline External Tables for CSV Load &raquo;</a></div><div class="disqus-comments"><div id="disqus_thread"></div><script type="text/javascript"> /* <![CDATA[ */ var disqus_shortname = "leelindleyscratchpad"; var disqus_identifier = "https://lee-lindley.github.io_CSV Clob and Private Temporary Table"; var disqus_title = "CSV Clob and Private Temporary Table"; /* * * DON'T EDIT BELOW THIS LINE * * */ (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); /* ]]> */ </script></div><footer> &copy; Lee Lindley - <a href="https://github.com/lee-lindley">https://github.com/lee-lindley</a> - Powered by Jekyll.<div class="btn-github" style="float:right;"> <iframe src="https://ghbtns.com/github-btn.html?user=agusmakmun&repo=agusmakmun.github.io&type=star&count=true" frameborder="0" scrolling="0" width="100" height="20px"></iframe> <iframe src="https://ghbtns.com/github-btn.html?user=agusmakmun&repo=agusmakmun.github.io&type=fork&count=true" frameborder="0" scrolling="0" width="100" height="20px"></iframe></div></footer></div></div><script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script> <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script> <script src="/static/js/bootstrap.min.js"></script> <script src="/static/js/super-search.js"></script> <script src="/static/js/thickbox-compressed.js"></script> <script src="/static/js/projects.js"></script>
