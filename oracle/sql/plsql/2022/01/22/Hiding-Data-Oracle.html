<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="shortcut icon" href="/static/img/favicon.ico" /><title>Protecting/Hiding Data in Oracle - Lee Lindley Scratchpad</title><meta name="author" content="Lee Lindley" /><meta name="description" content="Protecting/Hiding Data in Oracle" /><meta name="keywords" content="Protecting/Hiding Data in Oracle, Lee Lindley Scratchpad, oracle, sql, plsql" /><link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml"><meta content="" property="fb:app_id"><meta content="Lee Lindley Scratchpad" property="og:site_name"><meta content="Protecting/Hiding Data in Oracle" property="og:title"><meta content="article" property="og:type"><meta content="Posts on Technical Subjects, mostly Oracle and Linux" property="og:description"><meta content="https://lee-lindley.github.io/oracle/sql/plsql/2022/01/22/Hiding-Data-Oracle.html" property="og:url"><meta content="2022-01-22T10:30:00-05:00" property="article:published_time"><meta content="https://lee-lindley.github.io/about/" property="article:author"><meta content="oracle" property="article:section"><meta content="oracle" property="article:tag"><meta content="sql" property="article:tag"><meta content="plsql" property="article:tag"><meta content="ssh" property="article:tag"><meta content="sftp" property="article:tag"><meta content="dbms_rls" property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@"><meta name="twitter:creator" content="@"><meta name="twitter:title" content="Protecting/Hiding Data in Oracle"><meta name="twitter:url" content="https://lee-lindley.github.io/oracle/sql/plsql/2022/01/22/Hiding-Data-Oracle.html"><meta name="twitter:description" content="Posts on Technical Subjects, mostly Oracle and Linux"><link href="/static/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous"><link rel="stylesheet" href="/static/css/syntax.css"><link href="/static/css/bootstrap.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:400,300italic,300,400italic,700&amp;subset=latin,latin-ext" rel="stylesheet" type="text/css"><link rel="stylesheet" href="/static/css/super-search.css"><link rel="stylesheet" href="/static/css/thickbox.css"><link rel="stylesheet" href="/static/css/projects.css"><link rel="stylesheet" href="/static/css/main.css"><body><div class="container"><div class="col-sm-3"><div class="fixed-condition"><h1 class="author-name"><a href="/">Lee Lindley</a></h1><div class="profile-about"> I'm Just Another Perl Hacker who wound up in a big Oracle Database playground</div><div class="social"><ul><li><a href="https://linkedin.com/in/lee-lindley" target="_blank"><i class="fa fa-linkedin"></i></a><li><a href="https://github.com/lee-lindley" target="_blank"><i class="fa fa-github"></i></a></ul></div><div class="search" id="js-search"> <input type="text" placeholder="(sitemap)~$ type to search" class="search__input form-control" id="js-search__input"><ul class="search__results" id="js-search__results"></ul></div><hr /><ul class="sidebar-nav"> <strong>Navigation</strong><li><a href="/">Home</a><li><a class="about" href="/about/">About Me</a><li><a class="about" href="/projects/">My Projects</a><li><a class="about" href="/feed.xml">XML Feed</a></ul></div></div><div class="col-sm-8 col-offset-1 main-layout"><header class="post-header"><h1 class="post-title">Protecting/Hiding Data in Oracle</h1></header><span class="time">22 Jan 2022</span> <span class="categories"> &raquo; <a href="/category/oracle">oracle</a>, <a href="/category/sql">sql</a>, <a href="/category/plsql">plsql</a> </span><div class="content"><div class="post"><h2 id="the-ask">The Ask</h2><p>While experimenting with <a href="https://github.com/antonscheffer/as_sftp">as_sftp</a>, a package by Anton Scheffer that implements a Secure File Transfer Protocol (SFTP) utility in Oracle PL/SQL, I encountered an issue (or want) of storing SSH private keys in the database. That opens a can of worms because private keys should be secured as much as possible.<p>On a Unix system the private keys are kept in files in ~/.ssh directory with permissions set to be readable only by the user login associated with that HOME directory. Of course anyone with root or sudo privs can get the file, but that is the level of security we have come to expect for SSH client implementations. It is also one of the reasons some corporations have issues with ssh and go to lengths to prevent using it except where absolutely necessary. I digress.<p>I need to store private keys in the database with the following requirements:<ul><li>Not visible to any user except the schema owner (and DBA, but only because we can’t keep them out).<li>Accessible to a particular procedure that calls the <em>login</em> method of <em>as_sftp</em>.<li>Not accessible to any other procedures or queries.<li>Not visible to the schema owner if possible. The reason for this odd seeming requirement is that in most corporate systems a schema owner for deployed code is a shared account. Even if it is protected from login, there are multiple developers who deploy code into the schema. We want to control access to the single deployer and the procedure that needs the private key.</ul><table class="img-table-centered"><thead><tr><th style="text-align: center"><em>Hiding Data Use Cases</em><tbody><tr><td style="text-align: center"><img src="/images/hiding_data_use_case.gif" alt="Use_Case" /></table><p>I can see altering the use case to have separate privileges for the DML operations versus the SFTP Login, but I’m going to combine them for now.<p>As shown in the diagram, the authorized user does not have a use case for obtaining the private key directly or even to tell that there is a key available. That is by design.<h2 id="options">Options</h2><p>I considered a package with the source obfuscated via the utility <em>wrap</em>. From the documentation though<blockquote><p>Although wrapping a compilation unit helps to hide the algorithm and makes reverse-engineering difficult, Oracle Corporation does not recommend it as a secure method for hiding passwords or table names. Obfuscating a PL/SQL unit prevents most users from examining the source code, but might not stop all attempts.</blockquote><p>It might be good enough for our use case, but there are other issues. This package or function will be executable by the schema owner, who in our target environment is a shared account. We also do not control all database security and a surprising number of other accounts may have elevated privliges including EXECUTE ANY PROCEDURE (yea, don’t. OK. Not my circus. Not my monkeys.).<p>As for storing the key in a table, even more frequently found in the wild is the grant of SELECT ANY TABLE.<p>I considered putting some sort of encryption on the text of the key in the table, but that just kicks the can around because now the key for that encryption needs to be stored somewhere. Not helpful.<p>I briefly flirted with using a Context, but it has to be loaded somehow and we are back to protecting that operation.<p>I settled on Oracle Fine-Grained Access Control (See Oracle Database Security Guide and <em>DBMS_RLS</em> for your release).<p>The solution won’t stop that person with EXECUTE ANY PROCEDURE from running our login procedure which uses our private key (shame on the DBA!), but it prevents them from grabbing the private key and using it elsewhere. Even this issue might be solved if we add a check for calling <em>user</em> in the policy, but I have not gone there yet.<p>There is an extensive amount of debug logging available in <em>as_sftp</em>. I have not taken the time to explore it all to see if the private keys can be exposed.<p>I am not a security expert. It is possible there are more glaring holes in what I have built. Everything I’ve checked suggests this is good against any but a SYSDBA privileged user account, yet I’m not going to claim this is a secure solution. I just do not know. This is an exercise in implementing Fine Grained Access Control.<h2 id="fine-grained-access-control-configuration">Fine Grained Access Control Configuration</h2><p>The documentation and examples center around use of a context that you populate with a login trigger to restrict access to particular logins or scenarios as to how the session was entered. Much of that does not fit my use case.<p>What does fit is that we can install functions that control whether or not a SELECT, INSERT, UPDATE or DELETE operation will or will not work based on logic we implement. In this context “not work” means a SELECT will return 0 rows but no error, while a DML operation will return either 0 rows updated/deleted, or in the case of insert, a policy error exception. No user or procedure can manipulate the data in this table without passing our policy check.<p>The exceptions to this are that the schema owner can perform DDL on the table including TRUNCATE and DROP, and anyone with SYSDBA priv can do whatever they want. These conditions are acceptable to me. To take it any further we would need to create a separate schema for the table and packages. That might be best, but in most corporate environments, it is expensive to do. That said, if I was installing <em>as_sftp</em> as a DBA for general use that is where I would go with it.<p>My intent is for the policy check functions to look at the call stack and only allow the operation to succeed if we are called by a specific schema owned package function/procedure. Mostly that means my supplemental <em>login</em> procedure that retrieves the private key and calls <em>as_sftp.login</em>.<h2 id="implementation">Implementation</h2><p>This implementation is for a single schema owner. If it was to be shared across multiple schemas, there would likely need to be an additional primary key field in the table for <strong>who</strong> is running the operation. That would also need to consider how Mr. Scheffer configured the <em>as_sfpt_known_hosts</em> operation. It may be possible to define this with INVOKER rights and force each schema owner to implement their own tables, but that seems draconian. Tracking everything by the <em>user</em> identification of the caller would be my choice.<h3 id="as_sftp_private_keys-table">as_sftp_private_keys Table</h3><div class="language-plsql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">CREATE</span> <span class="kr">TABLE</span> <span class="n">as_sftp_private_keys</span>
<span class="p">(</span>
    <span class="k">host</span>  <span class="kt">VARCHAR2</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="ow">NOT</span> <span class="kr">NULL</span>
    <span class="p">,</span><span class="k">id</span>   <span class="kt">VARCHAR2</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="ow">NOT</span> <span class="kr">NULL</span>
    <span class="p">,</span><span class="k">key</span>  <span class="kt">CLOB</span> <span class="ow">NOT</span> <span class="kr">NULL</span>
    <span class="p">,</span><span class="k">CONSTRAINT</span> <span class="n">as_sftp_private_keys_pk</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="k">host</span><span class="p">,</span> <span class="k">id</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div><h3 id="as_sftp_keymgmt-package-specfication">as_sftp_keymgmt Package Specfication</h3><div class="language-plsql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">CREATE</span> <span class="kr">OR</span> <span class="kr">REPLACE</span> <span class="kr">PACKAGE</span> <span class="n">as_sftp_keymgmt</span> <span class="kr">AS</span>
    <span class="c1">--</span>
    <span class="c1">-- Important! The private key lookup is case sensitive on i_host and i_user.</span>
    <span class="c1">--</span>
    <span class="k">PROCEDURE</span> <span class="n">login</span><span class="p">(</span><span class="n">i_host</span> <span class="kt">VARCHAR2</span><span class="p">,</span> <span class="n">i_user</span> <span class="kt">VARCHAR2</span><span class="p">,</span> <span class="n">i_passphrase</span> <span class="kt">VARCHAR2</span> <span class="o">:=</span> <span class="kr">NULL</span><span class="p">,</span> <span class="n">i_log_level</span> <span class="kt">pls_integer</span> <span class="o">:=</span> <span class="kr">null</span><span class="p">);</span>
<span class="c1">-- comment out this function when done testing. It should not be public</span>
    <span class="c1">--FUNCTION get_priv_key(i_host VARCHAR2, i_user VARCHAR2) RETURN CLOB;</span>
    <span class="c1">--</span>
    <span class="c1">-- When keymgmt_security is activated (fine grained access control)</span>
    <span class="c1">-- These three methods are the only way to manipuate the data in the table as_sftp_private_keys</span>
    <span class="c1">-- other than to truncate it or do the task as sysdba.</span>
    <span class="c1">-- You cannot read the data at all as get_priv_key is a private function that only login() can call.</span>
    <span class="c1">--</span>
    <span class="k">PROCEDURE</span> <span class="n">insert_priv_key</span><span class="p">(</span><span class="n">i_host</span> <span class="kt">VARCHAR2</span><span class="p">,</span> <span class="n">i_user</span> <span class="kt">VARCHAR2</span><span class="p">,</span> <span class="n">i_key</span> <span class="kt">CLOB</span><span class="p">);</span>
    <span class="k">PROCEDURE</span> <span class="n">update_priv_key</span><span class="p">(</span><span class="n">i_host</span> <span class="kt">VARCHAR2</span><span class="p">,</span> <span class="n">i_user</span> <span class="kt">VARCHAR2</span><span class="p">,</span> <span class="n">i_key</span> <span class="kt">CLOB</span><span class="p">);</span>
    <span class="k">PROCEDURE</span> <span class="n">delete_priv_key</span><span class="p">(</span><span class="n">i_host</span> <span class="kt">VARCHAR2</span><span class="p">,</span> <span class="n">i_user</span> <span class="kt">VARCHAR2</span><span class="p">);</span>
<span class="k">END</span> <span class="n">as_sftp_keymgmt</span><span class="p">;</span>
</code></pre></div></div><p>While testing I made the function <em>get_priv_key</em> public so that I could validate what it was doing. It should be private.<p>The procuedure <em>login</em> will lookup the private key (using <em>get_priv_key</em>) and call <em>as_sftp.login</em> using it.<p>The three DML procedures allow operations on individual private key records for anyone granted execute on the package. As noted, it might be better to put those in a separate package.<p>So far what we have implemented will work without installing the fine grained access control components. Although anyone with SELECT priv on the table can see our keys, the storage of keys and use of them automatically during login will work much like SSH/SFTP does on Unix by looking up the key.<h3 id="as_sftp_keymgmt_security-package-specification">as_sftp_keymgmt_security PACKAGE Specification</h3><p><em>as_sftp_keymgmt_security</em> package implements the policy checks that will, when installed via <em>DBMS_RLS</em>, control whether access to table <em>as_sftp_private_keys</em> is permitted.<div class="language-plsql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">CREATE</span> <span class="kr">OR</span> <span class="kr">REPLACE</span> <span class="kr">PACKAGE</span> <span class="n">as_sftp_keymgmt_security</span>
<span class="kr">AS</span>
    <span class="c1">--</span>
    <span class="c1">-- These control access to records in the table as_sftp_private_keys</span>
    <span class="c1">--</span>
    <span class="k">FUNCTION</span> <span class="n">user_data_select_security</span> <span class="p">(</span><span class="k">owner</span> <span class="kt">VARCHAR2</span><span class="p">,</span> <span class="n">objname</span> <span class="kt">VARCHAR2</span><span class="p">)</span>
    <span class="k">RETURN</span> <span class="kt">VARCHAR2</span><span class="p">;</span>
    <span class="k">FUNCTION</span> <span class="n">user_data_insert_security</span> <span class="p">(</span><span class="k">owner</span> <span class="kt">VARCHAR2</span><span class="p">,</span> <span class="n">objname</span> <span class="kt">VARCHAR2</span><span class="p">)</span>
    <span class="k">RETURN</span> <span class="kt">VARCHAR2</span><span class="p">;</span>
    <span class="k">FUNCTION</span> <span class="n">user_data_update_security</span> <span class="p">(</span><span class="k">owner</span> <span class="kt">VARCHAR2</span><span class="p">,</span> <span class="n">objname</span> <span class="kt">VARCHAR2</span><span class="p">)</span>
    <span class="k">RETURN</span> <span class="kt">VARCHAR2</span><span class="p">;</span>
    <span class="k">FUNCTION</span> <span class="n">user_data_delete_security</span> <span class="p">(</span><span class="k">owner</span> <span class="kt">VARCHAR2</span><span class="p">,</span> <span class="n">objname</span> <span class="kt">VARCHAR2</span><span class="p">)</span>
    <span class="k">RETURN</span> <span class="kt">VARCHAR2</span><span class="p">;</span>
<span class="k">END</span> <span class="n">as_sftp_keymgmt_security</span><span class="p">;</span>
</code></pre></div></div><p>We will explore the package body after seeing how it is tied to the table.<h3 id="install_keymgmt_securitysql">install_keymgmt_security.sql</h3><p>This install script associates the functions in package <em>as_sftp_keymgmt_security</em> with each of the operations ‘SELECT’, ‘INSERT’, ‘UPDATE’, ‘DELETE’ on table <em>as_sftp_private_keys</em>.<p>The package <em>as_sftp_keymgmt_security</em> must be both publicly executable and have a public synonym for this to work. If you do not have the privilege to create a public synonym, the DBA must do it for you.<p>You may also need the DBA to ‘GRANT EXECUTE ON DBMS_RLS TO <strong>your_schema</strong>;’, though it is common enough to grant it to ‘PUBLIC’.<p>Of note is that the <em>add_policy</em> for ‘INSERT’ uses an additional parameter because ‘INSERT’ statements do not have ‘WHERE’ clauses. The implementation checks your condition after the insert, then raises an EXCEPTION if the operation is not allowed. This is different than the others where it quietly adds a WHERE condition to cause your operation to not match any rows.<div class="language-plsql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">GRANT</span> <span class="k">EXECUTE</span> <span class="kr">ON</span> <span class="n">as_sftp_keymgmt_security</span> <span class="kt">TO</span> <span class="kr">public</span><span class="p">;</span>
<span class="kr">CREATE</span> <span class="ow">OR</span> <span class="nf">REPLACE</span> <span class="kr">PUBLIC</span> <span class="kr">SYNONYM</span> <span class="n">as_sftp_keymgmt_security</span> <span class="kr">FOR</span> <span class="n">lee</span><span class="p">.</span><span class="n">as_sftp_keymgmt_security</span> <span class="p">;</span>
<span class="k">BEGIN</span>
    <span class="k">BEGIN</span>
        <span class="n">DBMS_RLS</span><span class="p">.</span><span class="n">drop_policy</span><span class="p">(</span><span class="o">'</span><span class="s1">LEE</span><span class="o">'</span><span class="p">,</span> <span class="o">'</span><span class="s1">AS_SFTP_PRIVATE_KEYS</span><span class="o">'</span><span class="p">,</span> <span class="o">'</span><span class="s1">USER_DATA_SELECT_POLICY</span><span class="o">'</span><span class="p">);</span>
    <span class="k">EXCEPTION</span> <span class="k">WHEN</span> <span class="k">OTHERS</span> <span class="kr">THEN</span> <span class="kr">NULL</span><span class="p">;</span>
    <span class="k">END</span><span class="p">;</span>
    <span class="n">DBMS_RLS</span><span class="p">.</span><span class="n">add_policy</span><span class="p">(</span><span class="o">'</span><span class="s1">LEE</span><span class="o">'</span><span class="p">,</span> <span class="o">'</span><span class="s1">AS_SFTP_PRIVATE_KEYS</span><span class="o">'</span><span class="p">,</span> <span class="o">'</span><span class="s1">USER_DATA_SELECT_POLICY</span><span class="o">'</span><span class="p">,</span>
                      <span class="o">'</span><span class="s1">LEE</span><span class="o">'</span><span class="p">,</span> <span class="o">'</span><span class="s1">AS_SFTP_KEYMGMT_SECURITY.USER_DATA_SELECT_SECURITY</span><span class="o">'</span><span class="p">,</span>
                      <span class="o">'</span><span class="s1">SELECT</span><span class="o">'</span><span class="p">);</span>
    <span class="k">BEGIN</span>
        <span class="n">DBMS_RLS</span><span class="p">.</span><span class="n">drop_policy</span><span class="p">(</span><span class="o">'</span><span class="s1">LEE</span><span class="o">'</span><span class="p">,</span> <span class="o">'</span><span class="s1">AS_SFTP_PRIVATE_KEYS</span><span class="o">'</span><span class="p">,</span> <span class="o">'</span><span class="s1">USER_DATA_INSERT_POLICY</span><span class="o">'</span><span class="p">);</span>
    <span class="k">EXCEPTION</span> <span class="k">WHEN</span> <span class="k">OTHERS</span> <span class="kr">THEN</span> <span class="kr">NULL</span><span class="p">;</span>
    <span class="k">END</span><span class="p">;</span>
    <span class="n">DBMS_RLS</span><span class="p">.</span><span class="n">add_policy</span><span class="p">(</span><span class="o">'</span><span class="s1">LEE</span><span class="o">'</span><span class="p">,</span> <span class="o">'</span><span class="s1">AS_SFTP_PRIVATE_KEYS</span><span class="o">'</span><span class="p">,</span> <span class="o">'</span><span class="s1">USER_DATA_INSERT_POLICY</span><span class="o">'</span><span class="p">,</span>
                      <span class="o">'</span><span class="s1">LEE</span><span class="o">'</span><span class="p">,</span> <span class="o">'</span><span class="s1">AS_SFTP_KEYMGMT_SECURITY.USER_DATA_INSERT_SECURITY</span><span class="o">'</span><span class="p">,</span>
                      <span class="o">'</span><span class="s1">INSERT</span><span class="o">'</span>
                    <span class="p">,</span><span class="k">TRUE</span> <span class="c1">-- needed because insert does not have where clause. check condition after insert</span>
                <span class="p">);</span>
    <span class="k">BEGIN</span>
        <span class="n">DBMS_RLS</span><span class="p">.</span><span class="n">drop_policy</span><span class="p">(</span><span class="o">'</span><span class="s1">LEE</span><span class="o">'</span><span class="p">,</span> <span class="o">'</span><span class="s1">AS_SFTP_PRIVATE_KEYS</span><span class="o">'</span><span class="p">,</span> <span class="o">'</span><span class="s1">USER_DATA_UPDATE_POLICY</span><span class="o">'</span><span class="p">);</span>
    <span class="k">EXCEPTION</span> <span class="k">WHEN</span> <span class="k">OTHERS</span> <span class="kr">THEN</span> <span class="kr">NULL</span><span class="p">;</span>
    <span class="k">END</span><span class="p">;</span>
    <span class="n">DBMS_RLS</span><span class="p">.</span><span class="n">add_policy</span><span class="p">(</span><span class="o">'</span><span class="s1">LEE</span><span class="o">'</span><span class="p">,</span> <span class="o">'</span><span class="s1">AS_SFTP_PRIVATE_KEYS</span><span class="o">'</span><span class="p">,</span> <span class="o">'</span><span class="s1">USER_DATA_UPDATE_POLICY</span><span class="o">'</span><span class="p">,</span>
                      <span class="o">'</span><span class="s1">LEE</span><span class="o">'</span><span class="p">,</span> <span class="o">'</span><span class="s1">AS_SFTP_KEYMGMT_SECURITY.USER_DATA_UPDATE_SECURITY</span><span class="o">'</span><span class="p">,</span>
                      <span class="o">'</span><span class="s1">UPDATE</span><span class="o">'</span><span class="p">);</span>
    <span class="k">BEGIN</span>
        <span class="n">DBMS_RLS</span><span class="p">.</span><span class="n">drop_policy</span><span class="p">(</span><span class="o">'</span><span class="s1">LEE</span><span class="o">'</span><span class="p">,</span> <span class="o">'</span><span class="s1">AS_SFTP_PRIVATE_KEYS</span><span class="o">'</span><span class="p">,</span> <span class="o">'</span><span class="s1">USER_DATA_DELETE_POLICY</span><span class="o">'</span><span class="p">);</span>
    <span class="k">EXCEPTION</span> <span class="k">WHEN</span> <span class="k">OTHERS</span> <span class="kr">THEN</span> <span class="kr">NULL</span><span class="p">;</span>
    <span class="k">END</span><span class="p">;</span>
    <span class="n">DBMS_RLS</span><span class="p">.</span><span class="n">add_policy</span><span class="p">(</span><span class="o">'</span><span class="s1">LEE</span><span class="o">'</span><span class="p">,</span> <span class="o">'</span><span class="s1">AS_SFTP_PRIVATE_KEYS</span><span class="o">'</span><span class="p">,</span> <span class="o">'</span><span class="s1">USER_DATA_DELETE_POLICY</span><span class="o">'</span><span class="p">,</span>
                      <span class="o">'</span><span class="s1">LEE</span><span class="o">'</span><span class="p">,</span> <span class="o">'</span><span class="s1">AS_SFTP_KEYMGMT_SECURITY.USER_DATA_DELETE_SECURITY</span><span class="o">'</span><span class="p">,</span>
                      <span class="o">'</span><span class="s1">DELETE</span><span class="o">'</span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
</code></pre></div></div><h3 id="as_sftp_keymgmt_security-package-body">as_sftp_keymgmt_security Package Body</h3><p>Now we get to the fun stuff. How are we determining that ONLY a specific package and method are allowed access? We look at the call stack. It is tricky though because the <em>DBMS_RLS</em> operations insert themselves into the call stack! You must look back a few levels to find the original caller.<div class="language-plsql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">CREATE</span> <span class="kr">OR</span> <span class="kr">REPLACE</span> <span class="kr">PACKAGE</span> <span class="kr">BODY</span> <span class="n">as_sftp_keymgmt_security</span> <span class="kr">IS</span>
    <span class="k">FUNCTION</span> <span class="n">user_data_select_security</span> <span class="p">(</span><span class="k">owner</span> <span class="kt">VARCHAR2</span><span class="p">,</span> <span class="n">objname</span> <span class="kt">VARCHAR2</span><span class="p">)</span>
    <span class="k">RETURN</span> <span class="kt">VARCHAR2</span>
    <span class="kr">IS</span>
        <span class="n">v_owner</span> <span class="kt">varchar2</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
        <span class="n">v_name</span> <span class="kt">varchar2</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
        <span class="n">v_lineno</span> <span class="kt">number</span><span class="p">;</span>
        <span class="n">v_caller_t</span> <span class="kt">varchar2</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>

        <span class="n">v_depth</span> <span class="kt">BINARY_INTEGER</span> <span class="o">:=</span> <span class="n">UTL_CALL_STACK</span><span class="p">.</span><span class="n">dynamic_depth</span><span class="p">;</span>
    <span class="k">BEGIN</span>
        <span class="k">IF</span> <span class="n">v_depth</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="kr">THEN</span>
            <span class="n">DBMS_OUTPUT</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">security check found not called by LEE.AS_SFTP_KEYMGMT.GET_PRIV_KEY.</span><span class="o">'</span><span class="p">);</span>
            <span class="n">dbms_output</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">call stack less than 4: </span><span class="o">'||</span><span class="n">v_depth</span><span class="p">);</span>
            <span class="n">DBMS_OUTPUT</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">Not allowing rows to be selected.</span><span class="o">'</span><span class="p">);</span>
            <span class="k">RETURN</span> <span class="o">'</span><span class="s1">1=0</span><span class="o">'</span><span class="p">;</span>
        <span class="k">END</span> <span class="k">IF</span><span class="p">;</span>
        <span class="cm">/*
        FOR i in 1..v_depth
        LOOP
            v_owner := UTL_CALL_STACK.owner(i);
            v_name := UTL_CALL_STACK.concatenate_subprogram(UTL_CALL_STACK.subprogram(i));
            dbms_output.put_line('i='||i||' owner: '||v_owner||' name: '||v_name);
        END LOOP;
        */</span>
        <span class="n">v_owner</span> <span class="o">:=</span> <span class="n">UTL_CALL_STACK</span><span class="p">.</span><span class="n">owner</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="n">v_name</span> <span class="o">:=</span> <span class="n">UTL_CALL_STACK</span><span class="p">.</span><span class="n">concatenate_subprogram</span><span class="p">(</span><span class="n">UTL_CALL_STACK</span><span class="p">.</span><span class="n">subprogram</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span>
        <span class="c1">--dbms_output.put_line('owner: '||v_owner||' name: '||v_name);</span>
        <span class="c1">--owa_util.who_called_me(v_owner, v_name, v_lineno, v_caller_t);</span>
        <span class="c1">--dbms_output.put_line('owner: '||v_owner||' name: '||v_name||' lineno: '||v_lineno||' caller_t: '||v_caller_t);</span>
        <span class="c1">--dbms_output.put_line(DBMS_UTILITY.format_call_stack);</span>
        <span class="k">IF</span> <span class="n">v_owner</span> <span class="o">=</span> <span class="o">'</span><span class="s1">LEE</span><span class="o">'</span> <span class="ow">AND</span> <span class="n">v_name</span> <span class="o">=</span> <span class="o">'</span><span class="s1">AS_SFTP_KEYMGMT.GET_PRIV_KEY</span><span class="o">'</span> <span class="kr">THEN</span>
            <span class="k">RETURN</span> <span class="kr">NULL</span><span class="p">;</span>
        <span class="kr">ELSE</span>
            <span class="n">DBMS_OUTPUT</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">security check found not called by LEE.AS_SFTP_KEYMGMT.GET_PRIV_KEY.</span><span class="o">'</span><span class="p">);</span>
            <span class="n">DBMS_OUTPUT</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">was called by owner: </span><span class="o">'||</span><span class="n">v_owner</span><span class="o">||'</span><span class="s1"> name: </span><span class="o">'||</span><span class="n">v_name</span><span class="p">);</span>
            <span class="n">DBMS_OUTPUT</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">Not allowing rows to be selected.</span><span class="o">'</span><span class="p">);</span>
            <span class="k">RETURN</span> <span class="o">'</span><span class="s1">1=0</span><span class="o">'</span><span class="p">;</span>
        <span class="k">END</span> <span class="k">IF</span><span class="p">;</span>
        <span class="c1">--RETURN NULL;</span>
    <span class="k">END</span> <span class="n">user_data_select_security</span>
    <span class="p">;</span>

    <span class="k">FUNCTION</span> <span class="n">user_data_insert_security</span> <span class="p">(</span><span class="k">owner</span> <span class="kt">VARCHAR2</span><span class="p">,</span> <span class="n">objname</span> <span class="kt">VARCHAR2</span><span class="p">)</span>
    <span class="k">RETURN</span> <span class="kt">VARCHAR2</span>
    <span class="kr">IS</span>
        <span class="n">v_owner</span> <span class="kt">varchar2</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
        <span class="n">v_name</span> <span class="kt">varchar2</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
        <span class="n">v_lineno</span> <span class="kt">number</span><span class="p">;</span>
        <span class="n">v_caller_t</span> <span class="kt">varchar2</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>

        <span class="n">v_depth</span> <span class="kt">BINARY_INTEGER</span> <span class="o">:=</span> <span class="n">UTL_CALL_STACK</span><span class="p">.</span><span class="n">dynamic_depth</span><span class="p">;</span>
    <span class="k">BEGIN</span>
        <span class="k">IF</span> <span class="n">v_depth</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="kr">THEN</span>
            <span class="n">DBMS_OUTPUT</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">security check found not called by LEE.AS_SFTP_KEYMGMT.INSERT_PRIV_KEY.</span><span class="o">'</span><span class="p">);</span>
            <span class="n">dbms_output</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">call stack less than 4: </span><span class="o">'||</span><span class="n">v_depth</span><span class="p">);</span>
            <span class="n">DBMS_OUTPUT</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">Not allowing rows to be selected.</span><span class="o">'</span><span class="p">);</span>
            <span class="k">RETURN</span> <span class="o">'</span><span class="s1">1=0</span><span class="o">'</span><span class="p">;</span>
        <span class="k">END</span> <span class="k">IF</span><span class="p">;</span>
        <span class="cm">/*
        FOR i in 1..v_depth
        LOOP
            v_owner := UTL_CALL_STACK.owner(i);
            v_name := UTL_CALL_STACK.concatenate_subprogram(UTL_CALL_STACK.subprogram(i));
            dbms_output.put_line('i='||i||' owner: '||v_owner||' name: '||v_name);
        END LOOP;
        */</span>
        <span class="n">v_owner</span> <span class="o">:=</span> <span class="n">UTL_CALL_STACK</span><span class="p">.</span><span class="n">owner</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="n">v_name</span> <span class="o">:=</span> <span class="n">UTL_CALL_STACK</span><span class="p">.</span><span class="n">concatenate_subprogram</span><span class="p">(</span><span class="n">UTL_CALL_STACK</span><span class="p">.</span><span class="n">subprogram</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span>
        <span class="c1">--dbms_output.put_line('owner: '||v_owner||' name: '||v_name);</span>
        <span class="c1">--owa_util.who_called_me(v_owner, v_name, v_lineno, v_caller_t);</span>
        <span class="c1">--dbms_output.put_line('owner: '||v_owner||' name: '||v_name||' lineno: '||v_lineno||' caller_t: '||v_caller_t);</span>
        <span class="c1">--dbms_output.put_line(DBMS_UTILITY.format_call_stack);</span>
        <span class="k">IF</span> <span class="n">v_owner</span> <span class="o">=</span> <span class="o">'</span><span class="s1">LEE</span><span class="o">'</span> <span class="ow">AND</span> <span class="n">v_name</span> <span class="o">=</span> <span class="o">'</span><span class="s1">AS_SFTP_KEYMGMT.INSERT_PRIV_KEY</span><span class="o">'</span> <span class="kr">THEN</span>
            <span class="k">RETURN</span> <span class="kr">NULL</span><span class="p">;</span>
        <span class="kr">ELSE</span>
            <span class="n">DBMS_OUTPUT</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">security check found not called by LEE.AS_SFTP_KEYMGMT.INSERT_PRIV_KEY.</span><span class="o">'</span><span class="p">);</span>
            <span class="n">DBMS_OUTPUT</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">was called by owner: </span><span class="o">'||</span><span class="n">v_owner</span><span class="o">||'</span><span class="s1"> name: </span><span class="o">'||</span><span class="n">v_name</span><span class="p">);</span>
            <span class="n">DBMS_OUTPUT</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">Not allowing rows to be inserted.</span><span class="o">'</span><span class="p">);</span>
            <span class="k">RETURN</span> <span class="o">'</span><span class="s1">1=0</span><span class="o">'</span><span class="p">;</span>
        <span class="k">END</span> <span class="k">IF</span><span class="p">;</span>
        <span class="c1">--RETURN NULL;</span>
    <span class="k">END</span> <span class="n">user_data_insert_security</span>
    <span class="p">;</span>
    <span class="k">FUNCTION</span> <span class="n">user_data_update_security</span> <span class="p">(</span><span class="k">owner</span> <span class="kt">VARCHAR2</span><span class="p">,</span> <span class="n">objname</span> <span class="kt">VARCHAR2</span><span class="p">)</span>
    <span class="k">RETURN</span> <span class="kt">VARCHAR2</span>
    <span class="kr">IS</span>
        <span class="n">v_owner</span> <span class="kt">varchar2</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
        <span class="n">v_name</span> <span class="kt">varchar2</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
        <span class="n">v_lineno</span> <span class="kt">number</span><span class="p">;</span>
        <span class="n">v_caller_t</span> <span class="kt">varchar2</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>

        <span class="n">v_depth</span> <span class="kt">BINARY_INTEGER</span> <span class="o">:=</span> <span class="n">UTL_CALL_STACK</span><span class="p">.</span><span class="n">dynamic_depth</span><span class="p">;</span>
    <span class="k">BEGIN</span>
        <span class="k">IF</span> <span class="n">v_depth</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="kr">THEN</span>
            <span class="n">DBMS_OUTPUT</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">security check found not called by LEE.AS_SFTP_KEYMGMT.UPDATE_PRIV_KEY.</span><span class="o">'</span><span class="p">);</span>
            <span class="n">dbms_output</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">call stack less than 4: </span><span class="o">'||</span><span class="n">v_depth</span><span class="p">);</span>
            <span class="n">DBMS_OUTPUT</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">Not allowing rows to be selected.</span><span class="o">'</span><span class="p">);</span>
            <span class="k">RETURN</span> <span class="o">'</span><span class="s1">1=0</span><span class="o">'</span><span class="p">;</span>
        <span class="k">END</span> <span class="k">IF</span><span class="p">;</span>
        <span class="cm">/*
        FOR i in 1..v_depth
        LOOP
            v_owner := UTL_CALL_STACK.owner(i);
            v_name := UTL_CALL_STACK.concatenate_subprogram(UTL_CALL_STACK.subprogram(i));
            dbms_output.put_line('i='||i||' owner: '||v_owner||' name: '||v_name);
        END LOOP;
        */</span>
        <span class="n">v_owner</span> <span class="o">:=</span> <span class="n">UTL_CALL_STACK</span><span class="p">.</span><span class="n">owner</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="n">v_name</span> <span class="o">:=</span> <span class="n">UTL_CALL_STACK</span><span class="p">.</span><span class="n">concatenate_subprogram</span><span class="p">(</span><span class="n">UTL_CALL_STACK</span><span class="p">.</span><span class="n">subprogram</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span>
        <span class="c1">--dbms_output.put_line('owner: '||v_owner||' name: '||v_name);</span>
        <span class="c1">--owa_util.who_called_me(v_owner, v_name, v_lineno, v_caller_t);</span>
        <span class="c1">--dbms_output.put_line('owner: '||v_owner||' name: '||v_name||' lineno: '||v_lineno||' caller_t: '||v_caller_t);</span>
        <span class="c1">--dbms_output.put_line(DBMS_UTILITY.format_call_stack);</span>
        <span class="k">IF</span> <span class="n">v_owner</span> <span class="o">=</span> <span class="o">'</span><span class="s1">LEE</span><span class="o">'</span> <span class="ow">AND</span> <span class="n">v_name</span> <span class="o">=</span> <span class="o">'</span><span class="s1">AS_SFTP_KEYMGMT.UPDATE_PRIV_KEY</span><span class="o">'</span> <span class="kr">THEN</span>
            <span class="k">RETURN</span> <span class="kr">NULL</span><span class="p">;</span>
        <span class="kr">ELSE</span>
            <span class="n">DBMS_OUTPUT</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">security check found not called by LEE.AS_SFTP_KEYMGMT.UPDATE_PRIV_KEY.</span><span class="o">'</span><span class="p">);</span>
            <span class="n">DBMS_OUTPUT</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">was called by owner: </span><span class="o">'||</span><span class="n">v_owner</span><span class="o">||'</span><span class="s1"> name: </span><span class="o">'||</span><span class="n">v_name</span><span class="p">);</span>
            <span class="n">DBMS_OUTPUT</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">Not allowing rows to be updated.</span><span class="o">'</span><span class="p">);</span>
            <span class="k">RETURN</span> <span class="o">'</span><span class="s1">1=0</span><span class="o">'</span><span class="p">;</span>
        <span class="k">END</span> <span class="k">IF</span><span class="p">;</span>
        <span class="c1">--RETURN NULL;</span>
    <span class="k">END</span> <span class="n">user_data_update_security</span>
    <span class="p">;</span>

    <span class="k">FUNCTION</span> <span class="n">user_data_delete_security</span> <span class="p">(</span><span class="k">owner</span> <span class="kt">VARCHAR2</span><span class="p">,</span> <span class="n">objname</span> <span class="kt">VARCHAR2</span><span class="p">)</span>
    <span class="k">RETURN</span> <span class="kt">VARCHAR2</span>
    <span class="kr">IS</span>
        <span class="n">v_owner</span> <span class="kt">varchar2</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
        <span class="n">v_name</span> <span class="kt">varchar2</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
        <span class="n">v_lineno</span> <span class="kt">number</span><span class="p">;</span>
        <span class="n">v_caller_t</span> <span class="kt">varchar2</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>

        <span class="n">v_depth</span> <span class="kt">BINARY_INTEGER</span> <span class="o">:=</span> <span class="n">UTL_CALL_STACK</span><span class="p">.</span><span class="n">dynamic_depth</span><span class="p">;</span>
    <span class="k">BEGIN</span>
        <span class="k">IF</span> <span class="n">v_depth</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="kr">THEN</span>
            <span class="n">DBMS_OUTPUT</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">security check found not called by LEE.AS_SFTP_KEYMGMT.DELETE_PRIV_KEY.</span><span class="o">'</span><span class="p">);</span>
            <span class="n">dbms_output</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">call stack less than 4: </span><span class="o">'||</span><span class="n">v_depth</span><span class="p">);</span>
            <span class="n">DBMS_OUTPUT</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">Not allowing rows to be selected.</span><span class="o">'</span><span class="p">);</span>
            <span class="k">RETURN</span> <span class="o">'</span><span class="s1">1=0</span><span class="o">'</span><span class="p">;</span>
        <span class="k">END</span> <span class="k">IF</span><span class="p">;</span>
        <span class="cm">/*
        FOR i in 1..v_depth
        LOOP
            v_owner := UTL_CALL_STACK.owner(i);
            v_name := UTL_CALL_STACK.concatenate_subprogram(UTL_CALL_STACK.subprogram(i));
            dbms_output.put_line('i='||i||' owner: '||v_owner||' name: '||v_name);
        END LOOP;
        */</span>
        <span class="n">v_owner</span> <span class="o">:=</span> <span class="n">UTL_CALL_STACK</span><span class="p">.</span><span class="n">owner</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="n">v_name</span> <span class="o">:=</span> <span class="n">UTL_CALL_STACK</span><span class="p">.</span><span class="n">concatenate_subprogram</span><span class="p">(</span><span class="n">UTL_CALL_STACK</span><span class="p">.</span><span class="n">subprogram</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span>
        <span class="c1">--dbms_output.put_line('owner: '||v_owner||' name: '||v_name);</span>
        <span class="c1">--owa_util.who_called_me(v_owner, v_name, v_lineno, v_caller_t);</span>
        <span class="c1">--dbms_output.put_line('owner: '||v_owner||' name: '||v_name||' lineno: '||v_lineno||' caller_t: '||v_caller_t);</span>
        <span class="c1">--dbms_output.put_line(DBMS_UTILITY.format_call_stack);</span>
        <span class="k">IF</span> <span class="n">v_owner</span> <span class="o">=</span> <span class="o">'</span><span class="s1">LEE</span><span class="o">'</span> <span class="ow">AND</span> <span class="n">v_name</span> <span class="o">=</span> <span class="o">'</span><span class="s1">AS_SFTP_KEYMGMT.DELETE_PRIV_KEY</span><span class="o">'</span> <span class="kr">THEN</span>
            <span class="k">RETURN</span> <span class="kr">NULL</span><span class="p">;</span>
        <span class="kr">ELSE</span>
            <span class="n">DBMS_OUTPUT</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">security check found not called by LEE.AS_SFTP_KEYMGMT.DELETE_PRIV_KEY.</span><span class="o">'</span><span class="p">);</span>
            <span class="n">DBMS_OUTPUT</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">was called by owner: </span><span class="o">'||</span><span class="n">v_owner</span><span class="o">||'</span><span class="s1"> name: </span><span class="o">'||</span><span class="n">v_name</span><span class="p">);</span>
            <span class="n">DBMS_OUTPUT</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="o">'</span><span class="s1">Not allowing rows to be deleted.</span><span class="o">'</span><span class="p">);</span>
            <span class="k">RETURN</span> <span class="o">'</span><span class="s1">1=0</span><span class="o">'</span><span class="p">;</span>
        <span class="k">END</span> <span class="k">IF</span><span class="p">;</span>
        <span class="c1">--RETURN NULL;</span>
    <span class="k">END</span> <span class="n">user_data_delete_security</span>
    <span class="p">;</span>
<span class="k">END</span> <span class="n">as_sftp_keymgmt_security</span><span class="p">;</span>
</code></pre></div></div><p>Much of the code is repeated so I could have refactored it. Maybe later.<h3 id="as_sftp_keymgmt-package-body">as_sftp_keymgmt PACKAGE BODY</h3><p>Implementation of the methods to do the login and DML is anticlimatic.<div class="language-plsql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">CREATE</span> <span class="kr">OR</span> <span class="kr">REPLACE</span> <span class="kr">PACKAGE</span> <span class="kr">BODY</span> <span class="n">as_sftp_keymgmt</span> <span class="kr">AS</span>
    <span class="c1">--</span>
    <span class="c1">-- This is the only method to select the private key when fine grained access control is added to the table</span>
    <span class="c1">-- with as_sftp_keymgt_security package. It is a package private function only called by login()</span>
    <span class="c1">--</span>
    <span class="k">FUNCTION</span> <span class="n">get_priv_key</span><span class="p">(</span><span class="n">i_host</span> <span class="kt">VARCHAR2</span><span class="p">,</span> <span class="n">i_user</span> <span class="kt">VARCHAR2</span><span class="p">)</span>
    <span class="k">RETURN</span> <span class="kt">CLOB</span>
    <span class="kr">IS</span>
        <span class="n">v_clob</span> <span class="kt">CLOB</span><span class="p">;</span>
    <span class="k">BEGIN</span>
        <span class="kr">SELECT</span> <span class="k">key</span> <span class="kr">INTO</span> <span class="n">v_clob</span>
        <span class="kr">FROM</span> <span class="n">as_sftp_private_keys</span> <span class="n">k</span>
        <span class="kr">WHERE</span> <span class="k">host</span> <span class="o">=</span> <span class="n">i_host</span> <span class="ow">AND</span> <span class="n">k</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">i_user</span>
        <span class="p">;</span>
        <span class="k">RETURN</span> <span class="n">v_clob</span><span class="p">;</span>
    <span class="k">EXCEPTION</span>
        <span class="k">WHEN</span> <span class="n">NO_DATA_FOUND</span> <span class="kr">THEN</span>
            <span class="n">raise_application_error</span><span class="p">(</span><span class="mi">-20713</span><span class="p">,</span> <span class="o">'</span><span class="s1">no record found in table as_sftp_private_keys for host=</span><span class="o">'||</span><span class="n">i_host</span><span class="o">||'</span><span class="s1">, id=</span><span class="o">'||</span><span class="n">i_user</span><span class="p">);</span>
    <span class="k">END</span> <span class="p">;</span>

    <span class="c1">--</span>
    <span class="c1">-- The method for obtaining the private key and using it to call as_sftp.login</span>
    <span class="c1">--</span>
    <span class="k">PROCEDURE</span> <span class="n">login</span><span class="p">(</span><span class="n">i_host</span> <span class="kt">VARCHAR2</span><span class="p">,</span> <span class="n">i_user</span> <span class="kt">VARCHAR2</span><span class="p">,</span> <span class="n">i_passphrase</span> <span class="kt">VARCHAR2</span> <span class="o">:=</span> <span class="kr">NULL</span><span class="p">,</span> <span class="n">i_log_level</span> <span class="kt">pls_integer</span> <span class="o">:=</span> <span class="kr">null</span><span class="p">)</span>
    <span class="kr">IS</span>
        <span class="n">v_priv_key</span> <span class="kt">VARCHAR2</span><span class="p">(</span><span class="mi">32767</span><span class="p">)</span> <span class="o">:=</span> <span class="n">get_priv_key</span><span class="p">(</span><span class="n">i_host</span><span class="p">,</span> <span class="n">i_user</span><span class="p">);</span>
    <span class="k">BEGIN</span>
        <span class="n">as_sftp</span><span class="p">.</span><span class="n">login</span><span class="p">(</span><span class="n">i_log_level</span> <span class="o">=&gt;</span> <span class="n">i_log_level</span><span class="p">,</span> <span class="n">i_user</span> <span class="o">=&gt;</span> <span class="n">i_user</span><span class="p">,</span> <span class="n">i_priv_key</span> <span class="o">=&gt;</span> <span class="n">v_priv_key</span><span class="p">,</span> <span class="n">i_passphrase</span> <span class="o">=&gt;</span> <span class="n">i_passphrase</span><span class="p">);</span>
    <span class="k">END</span><span class="p">;</span>

    <span class="c1">--</span>
    <span class="c1">-- 3 DML methods for manipulating the key table records</span>
    <span class="c1">--</span>
    <span class="k">PROCEDURE</span> <span class="n">insert_priv_key</span><span class="p">(</span><span class="n">i_host</span> <span class="kt">VARCHAR2</span><span class="p">,</span> <span class="n">i_user</span> <span class="kt">VARCHAR2</span><span class="p">,</span> <span class="n">i_key</span> <span class="kt">CLOB</span><span class="p">)</span>
    <span class="kr">IS</span>
    <span class="k">BEGIN</span>
        <span class="kr">INSERT</span> <span class="kr">INTO</span> <span class="n">as_sftp_private_keys</span><span class="p">(</span><span class="k">host</span><span class="p">,</span> <span class="k">id</span><span class="p">,</span> <span class="k">key</span><span class="p">)</span> <span class="kr">VALUES</span><span class="p">(</span><span class="n">i_host</span><span class="p">,</span> <span class="n">i_user</span><span class="p">,</span> <span class="n">i_key</span><span class="p">);</span>
        <span class="k">COMMIT</span><span class="p">;</span>
    <span class="k">END</span> <span class="n">insert_priv_key</span><span class="p">;</span>

    <span class="k">PROCEDURE</span> <span class="n">update_priv_key</span><span class="p">(</span><span class="n">i_host</span> <span class="kt">VARCHAR2</span><span class="p">,</span> <span class="n">i_user</span> <span class="kt">VARCHAR2</span><span class="p">,</span> <span class="n">i_key</span> <span class="kt">CLOB</span><span class="p">)</span>
    <span class="kr">IS</span>
    <span class="k">BEGIN</span>
        <span class="kr">UPDATE</span> <span class="n">as_sftp_private_keys</span>
            <span class="nf">SET</span> <span class="k">key</span> <span class="o">=</span> <span class="n">i_key</span>
            <span class="kr">WHERE</span> <span class="k">host</span> <span class="o">=</span> <span class="n">i_host</span> <span class="ow">AND</span> <span class="k">id</span> <span class="o">=</span> <span class="n">i_user</span>
            <span class="p">;</span>
        <span class="k">COMMIT</span><span class="p">;</span>
    <span class="k">END</span> <span class="n">update_priv_key</span><span class="p">;</span>

    <span class="k">PROCEDURE</span> <span class="n">delete_priv_key</span><span class="p">(</span><span class="n">i_host</span> <span class="kt">VARCHAR2</span><span class="p">,</span> <span class="n">i_user</span> <span class="kt">VARCHAR2</span><span class="p">)</span>
    <span class="kr">IS</span>
    <span class="k">BEGIN</span>
        <span class="kr">DELETE</span> <span class="kr">FROM</span> <span class="n">as_sftp_private_keys</span>
            <span class="kr">WHERE</span> <span class="k">host</span> <span class="o">=</span> <span class="n">i_host</span> <span class="ow">AND</span> <span class="k">id</span> <span class="o">=</span> <span class="n">i_user</span>
            <span class="p">;</span>
        <span class="k">COMMIT</span><span class="p">;</span>
    <span class="k">END</span> <span class="n">delete_priv_key</span><span class="p">;</span>
<span class="k">END</span> <span class="n">as_sftp_keymgmt</span><span class="p">;</span>
</code></pre></div></div><h2 id="conclusion">Conclusion</h2><p>The code shown here is available on my github page at <a href="https://github.com/lee-lindley/as_sftp_keymgmt">as_sftp_keymgmt</a>. I also forked <a href="https://github.com/lee-lindley/as_sftp">as_ftp</a> and put in a <a href="https://github.com/antonscheffer/as_sftp/pull/17">pull request</a> to Mr. Scheffer. That version is more extensive and completely integrated with <em>as_sftp</em>. I cannot imagine supporting it going forward though if Anton does not incorporate it. You are welcome to the code though.<p>I am not sure I enjoyed this exercise, but I learned enough about Oracle Fine Grained Access Control to accomplish my goal. Hope it was helpful.</div></div><div class="panel-body"><h4>Related Posts</h4><ul><li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/sql/2022/10/09/antijoins_with_or.html">Tuning Query with OR Conditions in a NOT EXISTS</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/sql">sql</a>)<li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/plsql/2022/09/18/spreadsheets_with_plsql.html">Manipulating XLSX Spreadsheets in PL/SQL</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/plsql">plsql</a>)<li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/perl/2022/04/30/perl_dbd_oracle_clob.html">Using Perl DBD::Oracle to write LOB content</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/perl">perl</a>)<li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/plsql/sql/vim/2022/04/29/vim-plsql-syntax.html">Syntax Highlighting for PL/SQL in vim</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/plsql">plsql</a>, <a href="/category/sql">sql</a>, <a href="/category/vim">vim</a>)<li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/perl/linux/2022/04/28/Perl-DBD-Oracle-RHL.html">Installing Perl DBD::Oracle on RHL</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/perl">perl</a>, <a href="/category/linux">linux</a>)<li class="relatedPost"> <a href="https://lee-lindley.github.io/oracle/sql/plsql/2022/04/10/hierarchical-profiler-context-switch.html">Profiling PL/SQL to Examine Context Switch Penalty</a> (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/sql">sql</a>, <a href="/category/plsql">plsql</a>)</ul></div><div class="PageNavigation"> <a class="prev" href="/oracle/plsql/html/2022/01/18/HTML-Table-PLSQL-Redux.html">&laquo; HTML Table Markup Redux</a> <a class="next" href="/oracle/sql/plsql/perl/2022/01/23/CSV-Clob-PTT.html">CSV Clob and Private Temporary Table &raquo;</a></div><div class="disqus-comments"><div id="disqus_thread"></div><script type="text/javascript"> /* <![CDATA[ */ var disqus_shortname = "leelindleyscratchpad"; var disqus_identifier = "https://lee-lindley.github.io_Protecting/Hiding Data in Oracle"; var disqus_title = "Protecting/Hiding Data in Oracle"; /* * * DON'T EDIT BELOW THIS LINE * * */ (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); /* ]]> */ </script></div><footer> &copy; Lee Lindley - <a href="https://github.com/lee-lindley">https://github.com/lee-lindley</a> - Powered by Jekyll.<div class="btn-github" style="float:right;"> <iframe src="https://ghbtns.com/github-btn.html?user=agusmakmun&repo=agusmakmun.github.io&type=star&count=true" frameborder="0" scrolling="0" width="100" height="20px"></iframe> <iframe src="https://ghbtns.com/github-btn.html?user=agusmakmun&repo=agusmakmun.github.io&type=fork&count=true" frameborder="0" scrolling="0" width="100" height="20px"></iframe></div></footer></div></div><script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script> <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script> <script src="/static/js/bootstrap.min.js"></script> <script src="/static/js/super-search.js"></script> <script src="/static/js/thickbox-compressed.js"></script> <script src="/static/js/projects.js"></script>
