<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="/static/img/favicon.ico" />
    <title>The Ubiquitous CSV File - Lee Lindley Scratchpad</title>
    <meta name="author" content="Lee Lindley" />
    <meta name="description" content="The Ubiquitous CSV File" />
    <meta name="keywords" content="The Ubiquitous CSV File, Lee Lindley Scratchpad, oracle, sql, plsql" />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
    <meta content="" property="fb:app_id">
    <meta content="Lee Lindley Scratchpad" property="og:site_name">

    

    
      <meta content="The Ubiquitous CSV File" property="og:title">
      <meta content="article" property="og:type">
    

    
      <meta content="Posts on Technical Subjects, mostly Oracle and Linux" property="og:description">
    

    
      <meta content="https://lee-lindley.github.io/oracle/sql/plsql/2021/09/10/Ubiquitous-CSV_file.html" property="og:url">
    

    
      <meta content="2021-09-10T11:30:00-04:00" property="article:published_time">
      <meta content="https://lee-lindley.github.io/about/" property="article:author">
    

    

    
      
        <meta content="oracle" property="article:section">
      
    

    
      
        <meta content="oracle" property="article:tag">
      
        <meta content="sql" property="article:tag">
      
        <meta content="plsql" property="article:tag">
      
        <meta content="csv" property="article:tag">
      
    

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@">

    
      <meta name="twitter:title" content="The Ubiquitous CSV File">
    

    
      <meta name="twitter:url" content="https://lee-lindley.github.io/oracle/sql/plsql/2021/09/10/Ubiquitous-CSV_file.html">
    

    
      <meta name="twitter:description" content="Posts on Technical Subjects, mostly Oracle and Linux">
    

    

    <!-- Font awesome icons -->
    <link href="/static/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/static/css/syntax.css">
    <!-- Bootstrap core CSS -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:400,300italic,300,400italic,700&amp;subset=latin,latin-ext" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/super-search.css">
    <link rel="stylesheet" href="/static/css/thickbox.css">
    <link rel="stylesheet" href="/static/css/projects.css">
    <link rel="stylesheet" href="/static/css/main.css">

    
  </head>
  <body>
    <div class="container">
      <div class="col-sm-3">
        <div class="fixed-condition">
          <h1 class="author-name"><a href="/">Lee Lindley</a></h1>
          
            <div class="profile-about">
              I'm Just Another Perl Hacker who wound up in a big Oracle Database playground
            </div>
          
          <div class="social">
            <ul>
              
                <li><a href="https://linkedin.com/in/lee-lindley" target="_blank"><i class="fa fa-linkedin"></i></a></li>
              
                <li><a href="https://github.com/lee-lindley" target="_blank"><i class="fa fa-github"></i></a></li>
              
            </ul>
          </div>
          <div class="search" id="js-search">
            <input type="text" placeholder="(sitemap)~$ type to search" class="search__input form-control" id="js-search__input">
            <ul class="search__results" id="js-search__results"></ul>
          </div>
          <hr />
          <ul class="sidebar-nav">
            <strong>Navigation</strong>
            <li><a href="/">Home</a></li>
            
              <li><a class="about" href="/about/">About Me</a></li>
            
              <li><a class="about" href="/projects/">My Projects</a></li>
            
              <li><a class="about" href="/feed.xml">XML Feed</a></li>
            
          </ul>
        </div>
        <!-- end /.fixed-condition -->
      </div>
      <div class="col-sm-8 col-offset-1 main-layout">
        <header class="post-header">
  <h1 class="post-title">The Ubiquitous CSV File</h1>
</header>

<span class="time">10 Sep 2021</span>

  <span class="categories">
    &raquo; <a href="/category/oracle">oracle</a>, <a href="/category/sql">sql</a>, <a href="/category/plsql">plsql</a>
  </span>


<div class="content">
  <div class="post"><h1 id="the-oh-so-common-csv-files">The Oh So Common CSV Files</h1>

<p>One of the most common methods for transferring data between applications and businesses 
is the comma separated value format file. It has many advantages:</p>

<ul>
  <li>It is relatively simple.</li>
  <li>It is entirely text, so it can be transported between computers running pretty much any operating system.</li>
  <li>It can be opened by common desktop applications like Excel.</li>
  <li>It isn’t that difficult to generate manually.</li>
  <li>Many applications can generate and consume it automatically.</li>
</ul>

<p>There is a semi-official standard for the format 
at <a href="https://www.loc.gov/preservation/digital/formats/fdd/fdd000323.shtml">RFC4180</a>,
but if you read it you will find it is fairly permissive about how you can quote
fields that contain separators and even newlines.</p>

<p>Parsing a CSV file seems simple
until you read all of the rules and sit down to try to do it. I have what I think
is a complete solution for parsing CSV in the Oracle PL/SQL 
function <a href="https://github.com/lee-lindley/plsql_utilities#split">split</a>. The regular
expression it employs is so ugly the comments outweigh the code ten to one. Yet
it seems to work just fine, passing all of the test cases I can conjour to throw at it.</p>

<h1 id="loading-csv-file">Loading CSV File</h1>

<p><em>sqlldr</em> (and by extension external tables) support a text import option that should
work for most honest CSV input files:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
</code></pre></div></div>

<p>I did not go out of my way to torture it the way I did my <em>split</em> function, yet the only
issues I’ve ever encountered with it had to do with funky non-ascii characters, which is
only tangentially related to the CSV format in that it depends on an understood common
or convertible character set. When the input file does not comply, as for instance when
a non-quoted string contains the delimiter, all bets are off.</p>

<p>If the input file follows <a href="https://www.loc.gov/preservation/digital/formats/fdd/fdd000323.shtml">RFC4180</a>,
I suspect Oracle <em>sqlldr</em> will parse it just fine. I could be wrong.</p>

<h1 id="generating-csv">Generating CSV</h1>

<p>From an Oracle database there are tools we can use to generate a CSV output file.</p>

<h2 id="gui-clients">GUI Clients</h2>

<p><em>Toad</em> and <em>Sqldeveloper</em> both have CSV format file output options. You chan choose whether
or not to quote and whether or not to include column headers. These work well, but they
require a person to execute them. That is not a viable solution to something you want to automate.</p>

<h2 id="sqlcl-aka-sql-command-line">SQLcl (aka sql command line)</h2>

<p><em>SQLcl</em> (SQL Developer Command Line) is a Java-based tool. It supports most of the cruft of <em>sqlplus</em>
while also adding new stuff and many of the features of <em>SqlDeveloper</em>. Although it ships with the Oracle
client, it may or may not be installed on your ETL server. It has a robust set of
output formats and is quite handy with CSV, both for exporting and for importing!</p>

<p>I have not seen
it used as a replacement for sqlplus and am not completely sure why. It may be that the people who
install and maintain database and ETL servers are just dinosaurs who don’t trust new stuff. I mean
it is only up to version 20.4. <em>sqlplus</em> on the other hand has been around as long as Oracle has been
and it is everywhere.</p>

<h2 id="sqlplus">sqlplus</h2>

<p><em>SQL*Plus 12.2</em> has added a <a href="https://docs.oracle.com/en/database/oracle/oracle-database/12.2/sqpug/SET-system-variable-summary.html#GUID-0AA910C4-C22A-4A9E-BE13-AAA059CC7919">set markup csv</a>
option, and when you turn on text quoting</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>set markup csv on quote on
</code></pre></div></div>

<p>it will “escape” double quotes embedded witin the text. 
This can also give you the column headers in CSV format when you have “set heading on”, 
so it may be a decent option. We will come back to that.</p>

<p>If you are stuck with an older version, you can concatenate data elements converted to text
with comma’s between them in your SQL statement and spool it to a text file. For example:</p>

<div class="language-plsql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">set</span> <span class="n">linesize</span> <span class="mi">200</span>
<span class="nf">set</span> <span class="n">pagesize</span> <span class="mi">0</span>
<span class="nf">set</span> <span class="n">heading</span> <span class="k">off</span>
<span class="nf">set</span> <span class="n">trimspool</span> <span class="kr">on</span>
<span class="nf">set</span> <span class="n">echo</span> <span class="k">off</span>
<span class="nf">set</span> <span class="n">termout</span> <span class="k">off</span>
<span class="n">spool</span> <span class="n">test1</span><span class="p">.</span><span class="n">csv</span>
<span class="kr">SELECT</span> 
    <span class="nf">TO_CHAR</span><span class="p">(</span><span class="n">department_id</span><span class="p">)</span>
    <span class="o">||'</span><span class="s1">,</span><span class="o">'||</span> <span class="n">department_name</span>
    <span class="o">||'</span><span class="s1">,</span><span class="o">'||</span> <span class="nf">TO_CHAR</span><span class="p">(</span><span class="n">manager_id</span><span class="p">)</span>
    <span class="o">||'</span><span class="s1">,</span><span class="o">'||</span> <span class="nf">TO_CHAR</span><span class="p">(</span><span class="n">location_id</span><span class="p">)</span>
<span class="kr">FROM</span> <span class="n">hr</span><span class="p">.</span><span class="n">departments</span> 
<span class="kr">ORDER</span> <span class="kr">BY</span> <span class="n">department_name</span>
<span class="p">;</span>
<span class="n">spool</span> <span class="k">off</span>
</code></pre></div></div>

<p>I have seen countless scripts like this in my career. I cringe every time I see one because I know it is
one careless data entry event away from waking up some poor support person in the middle of the night
when the file won’t load because there is a comma in one of the field values. A little better pattern
can protect against that:</p>

<div class="language-plsql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">set</span> <span class="n">linesize</span> <span class="mi">200</span>
<span class="nf">set</span> <span class="n">pagesize</span> <span class="mi">0</span>
<span class="nf">set</span> <span class="n">heading</span> <span class="k">off</span>
<span class="nf">set</span> <span class="n">trimspool</span> <span class="kr">on</span>
<span class="nf">set</span> <span class="n">echo</span> <span class="k">off</span>
<span class="nf">set</span> <span class="n">termout</span> <span class="k">off</span>
<span class="n">spool</span> <span class="n">test2</span><span class="p">.</span><span class="n">csv</span>
<span class="kr">SELECT</span> 
                  <span class="nf">TO_CHAR</span><span class="p">(</span><span class="n">department_id</span><span class="p">)</span>
    <span class="o">||'</span><span class="s1">,</span><span class="o">'||</span> <span class="o">'</span><span class="s1">"</span><span class="o">'||</span> <span class="n">department_name</span>           <span class="o">||'</span><span class="s1">"</span><span class="o">'</span>
    <span class="o">||'</span><span class="s1">,</span><span class="o">'||</span>       <span class="nf">TO_CHAR</span><span class="p">(</span><span class="n">manager_id</span><span class="p">)</span>
    <span class="o">||'</span><span class="s1">,</span><span class="o">'||</span>       <span class="nf">TO_CHAR</span><span class="p">(</span><span class="n">location_id</span><span class="p">)</span>
<span class="kr">FROM</span> <span class="n">hr</span><span class="p">.</span><span class="n">departments</span> 
<span class="kr">ORDER</span> <span class="kr">BY</span> <span class="n">department_name</span>
<span class="p">;</span>
<span class="n">spool</span> <span class="k">off</span>
</code></pre></div></div>

<p>Aside from how ugly it is and the chance that you make a mistake while typing it in, there is another
potential issue. What if the comma we fear is not what gets entered into the field value?
What if it is a double quote mark? What if it is a newline character?</p>

<p>I chose to not enclose the numeric fields with double quotes, but what if some joker changed the NLS
settings on us and the new default number format uses a comma for the decimal? DOH!</p>

<p>Another issue with this is that you don’t get the column headers. If you need them there are
several clever ways to do it. You can google search it. I’m not happy with any of them.</p>

<p>The markup csv option available starting in sqlplus that comes with Oracle 12c looks promising. 
Let’s try it out. We’ll add some tricks with the NLS
date and numeric default formats to see how smart it is. I’ve made both default conversion
formats contain a comma in the result.</p>

<p>First we will try with <em>quote off</em>.</p>

<div class="language-plsql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">ALTER</span> <span class="k">SESSION</span> <span class="nf">SET</span> <span class="k">nls_date_format</span> <span class="o">=</span> <span class="o">'</span><span class="s1">YYYYMMDD, HH24:MI</span><span class="o">'</span><span class="p">;</span>
<span class="kr">ALTER</span> <span class="k">SESSION</span> <span class="nf">SET</span> <span class="k">nls_numeric_characters</span> <span class="o">=</span> <span class="o">'</span><span class="s1">,.</span><span class="o">'</span><span class="p">;</span>
<span class="nf">set</span> <span class="n">markup</span> <span class="n">csv</span> <span class="kr">on</span> <span class="n">quote</span> <span class="k">off</span>
<span class="nf">set</span> <span class="n">linesize</span> <span class="mi">200</span>
<span class="nf">set</span> <span class="n">pagesize</span> <span class="mi">0</span>
<span class="c1">--set heading off</span>
<span class="nf">set</span> <span class="n">trimspool</span> <span class="kr">on</span>
<span class="nf">set</span> <span class="n">echo</span> <span class="k">off</span>
<span class="nf">set</span> <span class="n">termout</span> <span class="k">off</span>
<span class="n">spool</span> <span class="n">test_markup_noquote</span><span class="p">.</span><span class="n">csv</span>
<span class="kr">SELECT</span> 
    <span class="o">'</span><span class="s1">a string with comma(,)</span><span class="o">'</span> <span class="kr">AS</span> <span class="o">"</span><span class="nv">s1</span><span class="o">"</span>
    <span class="p">,</span><span class="o">'</span><span class="s1">a string with dquote(")</span><span class="o">'</span> <span class="kr">AS</span> <span class="o">"</span><span class="nv">s2</span><span class="o">"</span>
    <span class="p">,</span><span class="o">'</span><span class="s1">a string with newline(
)</span><span class="o">'</span> <span class="kr">AS</span> <span class="o">"</span><span class="nv">s3</span><span class="o">"</span>
    <span class="p">,</span><span class="nf">SYSDATE</span> <span class="kr">AS</span> <span class="o">"</span><span class="nv">date1</span><span class="o">"</span>
    <span class="p">,</span><span class="mi">12345</span> <span class="o">/</span> <span class="mi">100</span> <span class="kr">AS</span> <span class="o">"</span><span class="nv">num1</span><span class="o">"</span>
<span class="kr">FROM</span> <span class="n">DUAL</span>
<span class="p">;</span>
<span class="n">spool</span> <span class="k">off</span>
</code></pre></div></div>
<p>And now the spool file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cat test_markup_noquote.csv

s1,s2,s3,date1,num1
a string with comma(,),a string with dquote("),a string with newline(
),20210910, 04:52,123,45
</code></pre></div></div>

<p>As I suspected if you set quote off in the markup directive, you get what you paid for. That does
not comply with the CSV format specification.</p>

<p>It also seems to have both a leading and trailing blank line in it. Not sure what is up with that or whether
you can get rid of them short of doing something in the shell afterward. If I decide to use it
for a job, I’ll have to figure that out.</p>

<p>Let’s try the same but with <em>quote on</em></p>

<div class="language-plsql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">ALTER</span> <span class="k">SESSION</span> <span class="nf">SET</span> <span class="k">nls_date_format</span> <span class="o">=</span> <span class="o">'</span><span class="s1">YYYYMMDD, HH24:MI</span><span class="o">'</span><span class="p">;</span>
<span class="kr">ALTER</span> <span class="k">SESSION</span> <span class="nf">SET</span> <span class="k">nls_numeric_characters</span> <span class="o">=</span> <span class="o">'</span><span class="s1">,.</span><span class="o">'</span><span class="p">;</span>
<span class="nf">set</span> <span class="n">markup</span> <span class="n">csv</span> <span class="kr">on</span> <span class="n">quote</span> <span class="kr">on</span>
<span class="nf">set</span> <span class="n">linesize</span> <span class="mi">200</span>
<span class="nf">set</span> <span class="n">pagesize</span> <span class="mi">0</span>
<span class="c1">--set heading off</span>
<span class="nf">set</span> <span class="n">trimspool</span> <span class="kr">on</span>
<span class="nf">set</span> <span class="n">echo</span> <span class="k">off</span>
<span class="nf">set</span> <span class="n">termout</span> <span class="k">off</span>
<span class="n">spool</span> <span class="n">test_markup_wquote</span><span class="p">.</span><span class="n">csv</span>
<span class="kr">SELECT</span> 
    <span class="o">'</span><span class="s1">a string with comma(,)</span><span class="o">'</span> <span class="kr">AS</span> <span class="o">"</span><span class="nv">s1</span><span class="o">"</span>
    <span class="p">,</span><span class="o">'</span><span class="s1">a string with dquote(")</span><span class="o">'</span> <span class="kr">AS</span> <span class="o">"</span><span class="nv">s2</span><span class="o">"</span>
    <span class="p">,</span><span class="o">'</span><span class="s1">a string with newline(
)</span><span class="o">'</span> <span class="kr">AS</span> <span class="o">"</span><span class="nv">s3</span><span class="o">"</span>
    <span class="p">,</span><span class="nf">SYSDATE</span> <span class="kr">AS</span> <span class="o">"</span><span class="nv">date1</span><span class="o">"</span>
    <span class="p">,</span><span class="mi">12345</span> <span class="o">/</span> <span class="mi">100</span> <span class="kr">AS</span> <span class="o">"</span><span class="nv">num1</span><span class="o">"</span>
<span class="kr">FROM</span> <span class="n">DUAL</span>
<span class="p">;</span>
<span class="n">spool</span> <span class="k">off</span>
</code></pre></div></div>
<p>And now the spool file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"s1","s2","s3","date1","num1"
"a string with comma(,)","a string with dquote("")","a string with newline(
)","20210910, 05:06",123,45
</code></pre></div></div>

<p>Well that is interesting. It handles the character types that contain double quotes just
like the RFC specifies by doubling up the internal doublequote marks. A competent CSV parser
should have no trouble with that. As a bonus, it was smart enough to put double quotes around the 
date value converted by the default NLS format. Sweet! But it did NOT quote the number “num1” value
even though it contained a separator comma,
and that is a potential issue.  It is not a very likely issue to happen to you in the real world though.
And if you think it could be, you can always do the TO_CHAR conversion of numbers to strings in your
query.</p>

<p>Overall using sqlplus with the <em>markup csv</em>
option looks to be a fine way to generate CSV files.</p>

<h1 id="custom-tools">Custom Tools</h1>

<p>Maybe the ability to run a batch operation on an ETL server using sqlplus is not part of your
operational toolset. Maybe you need to generate the file from inside a program that is not able
to launch sqlplus, say for example you have a job that is running from DBMS_SCHEDULER_JOBS directly 
in the database, or the task is launched from a trigger or a web application interacting with the database.</p>

<p>For those scenarios where you cannot use a client program to generate the file, we can generate the
file using PL/SQL.</p>

<h2 id="the-hard-way">The Hard Way</h2>

<p>You can open a file on the database server and manually construct and write the CSV file.
This is a fairly common technique I have seen deployed by clients (though they rarely bothered
with the bulk collect).</p>

<div class="language-plsql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DECLARE</span>
    <span class="k">CURSOR</span> <span class="n">c1</span> <span class="kr">IS</span>
        <span class="kr">SELECT</span> <span class="n">e</span><span class="p">.</span><span class="n">employee_id</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">last_name</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span> <span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">,</span> <span class="n">salary</span>
        <span class="kr">FROM</span> <span class="n">hr</span><span class="p">.</span><span class="n">employees</span> <span class="n">e</span>
        <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">hr</span><span class="p">.</span><span class="n">departments</span> <span class="n">d</span>
            <span class="kr">ON</span> <span class="n">d</span><span class="p">.</span><span class="n">department_id</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">department_id</span>
        <span class="kr">ORDER</span> <span class="kr">BY</span> <span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">last_name</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">first_name</span>
    <span class="p">;</span>
    <span class="k">SUBTYPE</span> <span class="n">t_c1_rec</span> <span class="kr">IS</span> <span class="n">c1</span><span class="na">%ROWTYPE</span><span class="p">;</span>
    <span class="kr">TYPE</span> <span class="n">t_arr_c1_rec</span> <span class="kr">IS</span> <span class="kr">TABLE</span> <span class="kr">OF</span> <span class="n">t_c1_rec</span><span class="p">;</span>
    <span class="n">v_arr_c1_rec</span>    <span class="n">t_arr_c1_rec</span><span class="p">;</span>
    <span class="n">v_file</span>          <span class="n">UTL_FILE</span><span class="p">.</span><span class="n">file_type</span><span class="p">;</span>
    <span class="n">v_dir</span>           <span class="k">CONSTANT</span> <span class="kt">VARCHAR2</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="o">:=</span> <span class="o">'</span><span class="s1">TMP_DIR</span><span class="o">'</span><span class="p">;</span>
    <span class="n">v_file_name</span>     <span class="k">CONSTANT</span> <span class="kt">VARCHAR2</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="o">:=</span> <span class="o">'</span><span class="s1">test_csv_dbfile.csv</span><span class="o">'</span><span class="p">;</span>
<span class="k">BEGIN</span>
    <span class="n">v_file</span> <span class="o">:=</span> <span class="n">UTL_FILE</span><span class="p">.</span><span class="n">fopen</span><span class="p">(</span>
        <span class="n">filename</span>        <span class="o">=&gt;</span> <span class="n">v_file_name</span>
        <span class="p">,</span><span class="k">location</span>       <span class="o">=&gt;</span> <span class="n">v_dir</span>
        <span class="p">,</span><span class="n">open_mode</span>      <span class="o">=&gt;</span> <span class="o">'</span><span class="s1">w</span><span class="o">'</span>
        <span class="p">,</span><span class="n">max_linesize</span>   <span class="o">=&gt;</span> <span class="mi">32767</span>
    <span class="p">);</span>
    <span class="n">UTL_FILE</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="n">v_file</span><span class="p">,</span> <span class="o">'</span><span class="s1">employee_id,last_name,first_name,department_name,salary</span><span class="o">'</span><span class="p">);</span>
    <span class="k">OPEN</span> <span class="n">c1</span><span class="p">;</span>
    <span class="kr">LOOP</span>
        <span class="k">FETCH</span> <span class="n">c1</span> <span class="k">BULK</span> <span class="nf">COLLECT</span> <span class="kr">INTO</span> <span class="n">v_arr_c1_rec</span> <span class="k">LIMIT</span> <span class="mi">100</span><span class="p">;</span>
        <span class="kr">EXIT</span> <span class="k">WHEN</span> <span class="n">v_arr_c1_rec</span><span class="p">.</span><span class="nf">COUNT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kr">FOR</span> <span class="n">i</span> <span class="o">IN</span> <span class="mf">1.</span><span class="p">.</span><span class="n">v_arr_c1_rec</span><span class="p">.</span><span class="nf">COUNT</span>
        <span class="kr">LOOP</span>
            <span class="n">UTL_FILE</span><span class="p">.</span><span class="n">put_line</span><span class="p">(</span><span class="n">v_file</span><span class="p">,</span>
                <span class="nf">TO_CHAR</span><span class="p">(</span><span class="n">v_arr_c1_rec</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">employee_id</span><span class="p">)</span>
                <span class="o">||'</span><span class="s1">,"</span><span class="o">'||</span><span class="n">v_arr_c1_rec</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">last_name</span>           <span class="o">||'</span><span class="s1">"</span><span class="o">'</span>
                <span class="o">||'</span><span class="s1">,"</span><span class="o">'||</span><span class="n">v_arr_c1_rec</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">first_name</span>          <span class="o">||'</span><span class="s1">"</span><span class="o">'</span>
                <span class="o">||'</span><span class="s1">,"</span><span class="o">'||</span><span class="n">v_arr_c1_rec</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">department_name</span>     <span class="o">||'</span><span class="s1">"</span><span class="o">'</span>
                <span class="o">||'</span><span class="s1">,"</span><span class="o">'||</span><span class="nf">LTRIM</span><span class="p">(</span><span class="nf">TO_CHAR</span><span class="p">(</span><span class="n">v_arr_c1_rec</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">salary</span><span class="p">,</span><span class="o">'</span><span class="s1">$999,999,999.99</span><span class="o">'</span><span class="p">))</span>
                                                            <span class="o">||'</span><span class="s1">"</span><span class="o">'</span>
            <span class="p">);</span>
        <span class="k">END</span> <span class="kr">LOOP</span><span class="p">;</span>
    <span class="k">END</span> <span class="kr">LOOP</span><span class="p">;</span>
    <span class="k">CLOSE</span> <span class="n">c1</span><span class="p">;</span>
    <span class="n">UTL_FILE</span><span class="p">.</span><span class="n">fclose</span><span class="p">(</span><span class="n">v_file</span><span class="p">);</span>
    <span class="k">RETURN</span><span class="p">;</span>
<span class="k">EXCEPTION</span> <span class="k">WHEN</span> <span class="k">OTHERS</span> <span class="kr">THEN</span>
    <span class="k">IF</span> <span class="n">UTL_FILE</span><span class="p">.</span><span class="n">is_open</span><span class="p">(</span><span class="n">v_file</span><span class="p">)</span>
        <span class="kr">THEN</span> <span class="n">UTL_FILE</span><span class="p">.</span><span class="n">fclose</span><span class="p">(</span><span class="n">v_file</span><span class="p">);</span>
    <span class="k">END</span> <span class="k">IF</span><span class="p">;</span>
    <span class="kr">RAISE</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="o">/</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lee@linux2 [/tmp]
$ head -10 test_csv_dbfile.csv
employee_id,last_name,first_name,department_name,salary
206,"Gietz","William","Accounting","$8,300.00"
205,"Higgins","Shelley","Accounting","$12,008.00"
200,"Whalen","Jennifer","Administration","$4,400.00"
102,"De Haan","Lex","Executive","$17,000.00"
100,"King","Steven","Executive","$24,000.00"
101,"Kochhar","Neena","Executive","$17,000.00"
110,"Chen","John","Finance","$8,200.00"
109,"Faviet","Daniel","Finance","$9,000.00"
108,"Greenberg","Nancy","Finance","$12,008.00"
</code></pre></div></div>

<p>That works well enough, but man oh man is it painful.</p>

<h2 id="refcursor-to-csv">refcursor-to-csv</h2>

<p>William Robertson published a nice package that can generate CSV data that complies with the RFC
from any ref cursor. <a href="https://www.williamrobertson.net/documents/refcursor-to-csv.shtml">refcursor-to-csv</a>
is an approach that is completely within the database rather than in a client. This means
you can select the resulting CSV rows in any client or write them to a file on the database server. It is
a fine tool that may well meet your needs. He adds some bells and whistles for producing
optional header and trailer records that may be exactly what you are looking for.</p>

<p>Here are two examples from Mr. Robertson’s documentation at the above link:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select column_value
from   table(csv.report(cursor(
        select * from dept
    ), p_separator =&gt; '|', p_label =&gt; 'DEPT', p_heading =&gt; 'Y', p_rowcount =&gt; 'Y'));

COLUMN_VALUE
----------------------------------------------
HEADING|DEPT|DEPTNO|DNAME|LOC
DEPT|10|ACCOUNTING|NEW YORK
DEPT|20|RESEARCH|DALLAS
DEPT|30|SALES|CHICAGO
DEPT|40|OPERATIONS|BOSTON
ROW_COUNT|DEPT|4

6 rows selected.
</code></pre></div></div>

<p>And the example of writing to a file on the database server:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>declare
    l_dataset sys_refcursor;
begin
    open l_dataset for select * from dept;

    csv.write_file
    ( p_dataset =&gt; l_dataset
    , p_separator =&gt; '|', p_label =&gt; 'DEPT', p_heading =&gt; 'Y', p_rowcount =&gt; 'Y'
    , p_directory =&gt; 'DATA_FILE_DIR'
    , p_filename =&gt; 'dept.csv' );
end;
</code></pre></div></div>

<h2 id="app_csv">app_csv</h2>

<p>I was inspired by Mr. Robertson’s work to extend it in several ways where I wanted more flexibility.
I also had another use for the underlying mechanism of using DBMS_SQL to gather
the cursor results for any unknown query. I created base Object types I 
call <a href="https://github.com/lee-lindley/plsql_utilities#app_dbms_sql">app_dbms_sql</a>
and then built <a href="https://github.com/lee-lindley/app_csv">app_csv</a> on top of those.</p>

<p>The <a href="https://github.com/lee-lindley/app_csv#use-cases">app_csv documentation on use cases</a>
show selecting from a TABLE function, writing to a database server file, and retrieving
a CLOB. The latter is particularly useful if you want to email the CSV data as an attachment.
(See <a href="https://github.com/lee-lindley/html_email">html_email</a> for a tool that can send email with
attachments from the database server.)</p>

<p>Both of these tools process completely within the database engine.</p>

<h2 id="excelgen">ExcelGen</h2>

<p>If the only reason you are producing CSV files is because you want to give them to a user to open
in Excel, why stop there? <a href="https://github.com/mbleron/ExcelGen">ExcelGen</a> is a package by Marc Bleron that
can convert a refcursor (just like <em>app_csv</em> and <em>refcursor-to-csv</em> do) and generate an XLSX
file. Maybe your users are happy enough with opening a CSV file in excel and mucking with the column formats
for a few minutes every day, but you can go the extra step without a whole lot more trouble. Plus as a bonus
if you have multiple queries and files you are producing for them, you can combine them as separate
tabs/sheets in the same workbook. The format is compressed too so files are smaller.</p>

<p>It is just a little bit more work than producing CSV files, yet the end product is sure to be appreciated
by your users.</p>

<h1 id="conclusion">Conclusion</h1>

<p>These are some techniques you may be able to use to fit a need. Hope it was helpful.</p>
</div>
</div>


  
    
      
        
          
      
          
      
          
            
            <div class="panel-body">
              <h4>Related Posts</h4>
              <ul>
            
                <li class="relatedPost">
                  <a href="https://lee-lindley.github.io/plsql/sql/2022/03/20/Ruby-Rouge-Lexer-PLSQL.html">A Ruby/Rouge Lexer Class for Oracle PL/SQL</a>
                  
                    (Categories: <a href="/category/plsql">plsql</a>, <a href="/category/sql">sql</a>)
                  
                </li>
          
          
        
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
            
                <li class="relatedPost">
                  <a href="https://lee-lindley.github.io/oracle/sql/2022/03/06/Staging_Tables_vs_With.html">Staging Tables vs Single SQL</a>
                  
                    (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/sql">sql</a>)
                  
                </li>
          
          
        
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
            
                <li class="relatedPost">
                  <a href="https://lee-lindley.github.io/oracle/sql/plsql/perl/2022/01/24/CSV-Clob-Inline-External.html">Inline External Tables for CSV Load</a>
                  
                    (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/sql">sql</a>, <a href="/category/plsql">plsql</a>, <a href="/category/perl">perl</a>)
                  
                </li>
          
          
        
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
            
                <li class="relatedPost">
                  <a href="https://lee-lindley.github.io/oracle/sql/plsql/perl/2022/01/23/CSV-Clob-PTT.html">CSV Clob and Private Temporary Table</a>
                  
                    (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/sql">sql</a>, <a href="/category/plsql">plsql</a>, <a href="/category/perl">perl</a>)
                  
                </li>
          
          
        
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
            
                <li class="relatedPost">
                  <a href="https://lee-lindley.github.io/oracle/sql/plsql/2022/01/22/Hiding-Data-Oracle.html">Protecting/Hiding Data in Oracle</a>
                  
                    (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/sql">sql</a>, <a href="/category/plsql">plsql</a>)
                  
                </li>
          
          
        
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
            
                <li class="relatedPost">
                  <a href="https://lee-lindley.github.io/oracle/plsql/html/2022/01/18/HTML-Table-PLSQL-Redux.html">HTML Table Markup Redux</a>
                  
                    (Categories: <a href="/category/oracle">oracle</a>, <a href="/category/plsql">plsql</a>, <a href="/category/html">html</a>)
                  
                </li>
          
          
        
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
  
  </ul>
</div>


<div class="PageNavigation">
  
    <a class="prev" href="/oracle/sql/plsql/2021/09/09/Oracle-Objects-AppInterface.html">&laquo; Oracle Object Types as Application Interface</a>
  
  
    <a class="next" href="/oracle/sql/plsql/2021/09/25/Inline-PLSQL-Methods.html">Why do I need Inline PL/SQL Methods? &raquo;</a>
  
</div>

<div class="disqus-comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    /* <![CDATA[ */
    var disqus_shortname = "leelindleyscratchpad";
    var disqus_identifier = "https://lee-lindley.github.io_The Ubiquitous CSV File";
    var disqus_title = "The Ubiquitous CSV File";

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    /* ]]> */
  </script>
</div>

        <footer>
          &copy; Lee Lindley
          
            - <a href="https://github.com/lee-lindley">https://github.com/lee-lindley</a> - Powered by Jekyll.
          
          <div class="btn-github" style="float:right;">
            <iframe src="https://ghbtns.com/github-btn.html?user=agusmakmun&repo=agusmakmun.github.io&type=star&count=true" frameborder="0" scrolling="0" width="100" height="20px"></iframe>
            <iframe src="https://ghbtns.com/github-btn.html?user=agusmakmun&repo=agusmakmun.github.io&type=fork&count=true" frameborder="0" scrolling="0" width="100" height="20px"></iframe>
          </div>
        </footer>
      </div>
      <!-- end /.col-sm-8 -->
    </div>
    <!-- end /.container -->

    <!-- Bootstrap core JavaScript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/super-search.js"></script>
    <script src="/static/js/thickbox-compressed.js"></script>
    <script src="/static/js/projects.js"></script>
  </body>
</html>

